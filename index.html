<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="dark light">
  <title>GxMods Admin Panel</title>
  <style>
    :root{
      --bg:#0f1115;--card:#161a22;--stroke:#222633;--muted:#9aa4b2;
      --pri:#1e88ff;--pri2:#166ad9;--warn:#ef5350;--warn2:#e53935;
      --ok:#2eb872;--chip:#233049;--chipb:#2f3e5a;--ink:#e8e8e8;--ink2:#cbd5e1
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);color:var(--ink);margin:0;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 12px 80px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h2,h3,h4{margin:8px 0 12px}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    .row>label{min-width:110px;color:var(--muted)}
    input[type=text],input[type=password],textarea,select{
      flex:1;background:#0f1320;border:1px solid #232a3a;border-radius:12px;color:var(--ink);
      padding:12px 14px;outline:none;font-size:16px; /* nyaman buat jempol */
    }
    input,textarea{caret-color:var(--pri)}
    textarea{min-height:64px;resize:vertical}
    button{
      background:var(--pri);border:1px solid var(--pri2);border-radius:28px;color:#fff;
      padding:12px 16px;cursor:pointer;font-size:15px;min-width:44px;min-height:44px
    }
    button.alt{background:transparent;border-color:#395074;color:#a9c7ff}
    button.warn{background:var(--warn);border-color:var(--warn2)}
    .muted{color:var(--muted)} .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chipb);font-size:12px}
    .hide{display:none} .hr{height:1px;background:#283246;margin:14px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){ .grid{grid-template-columns:380px 1fr} }
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}
    .tag-warn{color:var(--warn)} .tag-ok{color:var(--ok)}
    .iconbtn{background:transparent;border:1px solid #2a3a55;color:#a9c7ff;border-radius:10px;padding:8px 10px}
    .iconbtn:active{transform:scale(.98)}

    /* Table & list */
    .table-wrap{width:100%;overflow:auto;border:1px solid #283246;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
    th,td{padding:12px;border-bottom:1px solid #283246;font-size:14px}
    th{text-align:left;color:var(--ink2);background:#121827;position:sticky;top:0}
    tr:hover{background:#121827}
    /* Card-list mode (mobile) */
    @media (max-width:720px){
      .wrap{padding-bottom:120px}
      .row>label{min-width:96px}
      .table-wrap{border:none}
      table{min-width:unset;border-spacing:0}
      thead{display:none}
      tr{display:block;background:#111620;border:1px solid #283246;border-radius:12px;margin:10px 4px}
      td{display:flex;justify-content:space-between;gap:8px;border:none;padding:10px 12px}
      td::before{content:attr(data-label);color:#93a4bd}
      td input[type=checkbox]{margin-left:auto}
    }

    /* Sticky batch bar for mobile comfort */
    .sticky-actions{
      position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(15,17,21,.0),rgba(15,17,21,.9) 20%,rgba(15,17,21,.98));
      border-top:1px solid #283246;padding:10px 12px;display:flex;gap:8px;align-items:center;z-index:5;backdrop-filter:saturate(1.2) blur(6px)
    }
    @media (min-width:980px){ .sticky-actions{position:static;background:transparent;border:none;padding:0;margin-top:8px} }
    .toast{
      position:fixed;left:50%;bottom:84px;transform:translateX(-50%);
      background:#1b2436;border:1px solid #31415c;color:#cfe3ff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:.2s;z-index:6
    }
    .toast.show{opacity:1}
    a.link{color:#9bc2ff;text-decoration:none}
    a.link:hover{text-decoration:underline}
  </style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login Admin (Email & Password)</h2>
    <div class="row">
      <label>Email</label>
      <input id="email" type="text" placeholder="admin@example.com" autocomplete="username" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="email"/>
    </div>
    <div class="row">
      <label>Password</label>
      <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
    </div>
    <div class="row">
      <button id="btnLogin">Login</button>
      <span id="loginMsg" class="muted"></span>
    </div>
  </div>

  <div class="hr"></div>

  <!-- PANEL -->
  <div id="panelCard" class="card hide">
    <div class="row">
      <div class="pill" id="meUid">UID: -</div>
      <div class="pill" id="isAdmin">Admin: -</div>
      <div class="pill" id="isOwner">Owner: -</div>
      <button id="btnLogout" class="alt right">Logout</button>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <!-- LEFT: Add + Search + Detail -->
      <div>
        <h3>Add / Edit User</h3>
        <div class="row">
          <label>Android ID</label>
          <input id="n_id" type="text" placeholder="a1b2c3d4e5f6abcd" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="latin"/>
          <button id="n_copy_id" class="iconbtn alt">Copy</button>
        </div>
        <div class="row">
          <label>Key</label>
          <input id="n_key" type="text" placeholder="ZXCV-9999-PAID" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <button id="n_gen" class="iconbtn alt">Generate</button>
          <button id="n_copy_key" class="iconbtn alt">Copy</button>
        </div>
        <div class="row">
          <label>Banned</label>
          <select id="n_banned"><option>false</option><option>true</option></select>
        </div>
        <div class="row"><label>Until</label><input id="n_until" type="text" placeholder="dd-MM-yyyy atau epoch/ms" inputmode="numeric"/></div>
        <div class="row"><label>Reason</label><textarea id="n_reason" placeholder="opsional"></textarea></div>
        <div class="toolbar">
          <button id="n_create">Create / Overwrite</button>
          <button id="n_reset" class="alt right">Reset</button>
          <span id="addMsg" class="muted"></span>
        </div>

        <div class="hr"></div>

        <h3>Search / Detail</h3>
        <div class="toolbar">
          <input id="searchId" type="text" placeholder="Android ID (exact)" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <button id="btnFindId" class="alt">Find by ID</button>
        </div>
        <div class="toolbar">
          <input id="searchKey" type="text" placeholder="Key (exact)" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <button id="btnFindKey" class="alt">Find by Key</button>
          <button id="btnClear" class="alt right">Clear</button>
        </div>

        <div id="detailBox" class="hide">
          <div class="hr"></div>
          <h4>Detail User</h4>
          <div class="row">
            <label>Android ID</label>
            <input id="d_id" type="text" disabled/>
            <button id="d_copy_id" class="iconbtn alt">Copy</button>
          </div>
          <div class="row">
            <label>Key</label>
            <input id="d_key" type="text" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <button id="d_rotate" class="iconbtn alt">Rotate</button>
            <button id="d_copy_key" class="iconbtn alt">Copy</button>
          </div>
          <div class="row"><label>Banned</label>
            <select id="d_banned"><option>false</option><option>true</option></select>
          </div>
          <div class="row"><label>Until</label><input id="d_until" type="text" placeholder="dd-MM-yyyy atau epoch/ms" inputmode="numeric"/></div>
          <div class="row"><label>Reason</label><textarea id="d_reason" placeholder="alasan ban (opsional)"></textarea></div>
          <div class="toolbar">
            <button id="d_ban" class="warn">Ban</button>
            <button id="d_unban" class="alt">Unban</button>
            <button id="d_save">Save</button>
            <button id="d_delete" class="warn right">Delete</button>
          </div>
          <div class="row"><span id="detailMsg" class="muted"></span></div>
        </div>
      </div>

      <!-- RIGHT: List & Batch -->
      <div>
        <h3>Users List</h3>
        <div class="toolbar">
          <button id="btnListAll" class="alt">List (100)</button>
          <button id="btnListBanned" class="alt">List Banned</button>
          <div class="right muted" id="listInfo"></div>
        </div>

        <div class="toolbar">
          <input id="prefixInput" type="text" placeholder="Cari prefix Android ID (mis. a1b2)" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <button id="btnSearchPrefix" class="alt">Search Prefix</button>
          <button id="btnClearPrefix" class="alt">Clear</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="chkAll"/></th>
                <th>Android ID</th>
                <th>Key</th>
                <th>Banned</th>
                <th>Until</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="6" class="muted">Belum ada data user yang dimuat.</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Sticky batch bar (mobile comfy) -->
        <div class="sticky-actions">
          <button id="batchBan" class="warn">Ban Selected</button>
          <button id="batchUnban" class="alt">Unban Selected</button>
          <button id="batchDelete" class="warn right">Delete Selected</button>
        </div>

        <div class="toolbar" style="margin-top:8px">
          <button id="prevPage" class="alt">Prev</button>
          <button id="nextPage" class="alt">Next</button>
        </div>

        <div class="hr"></div>

        <h3>Kelola Admin (Owner only)</h3>
        <div class="row"><label>UID</label><input id="adm_uid" type="text" placeholder="UID Firebase" autocapitalize="off" autocorrect="off" spellcheck="false"/></div>
        <div class="toolbar">
          <button id="adm_add" class="alt">Grant Admin</button>
          <button id="adm_del" class="warn">Revoke Admin</button>
          <span id="admMsg" class="muted"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Done</div>

<!-- Firebase v10 ES Modules (CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, get, set, update, remove, query, orderByKey, orderByChild, equalTo, startAt, endAt, limitToFirst } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

  // === CONFIG PROYEK ===
  const firebaseConfig = {
    apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
    authDomain: "animeplay-738a4.firebaseapp.com",
    databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
    projectId: "animeplay-738a4",
    storageBucket: "animeplay-738a4.firebasestorage.app",
    messagingSenderId: "129738568083",
    appId: "1:129738568083:web:d144ad8d1a66d893213866",
    measurementId: "G-J6G96TPMHX"
  };

  // UID owner (boleh kelola /admins)
  const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";

  // Init
  const app = initializeApp(firebaseConfig);
  try{ isSupported().then(ok=>{ if(ok) getAnalytics(app); }); }catch(_){}
  const auth = getAuth(app);
  const db   = getDatabase(app);

  // DOM refs
  const $ = id => document.getElementById(id);
  const loginCard=$("loginCard"), panelCard=$("panelCard");
  const meUid=$("meUid"), isAdmin=$("isAdmin"), isOwner=$("isOwner");
  const btnLogin=$("btnLogin"), loginMsg=$("loginMsg"), btnLogout=$("btnLogout");

  // Add/Edit
  const n_id=$("n_id"), n_key=$("n_key"), n_banned=$("n_banned"), n_until=$("n_until"), n_reason=$("n_reason");
  const n_gen=$("n_gen"), n_create=$("n_create"), n_reset=$("n_reset"), addMsg=$("addMsg"), n_copy_id=$("n_copy_id"), n_copy_key=$("n_copy_key");

  // Search & Detail
  const searchId=$("searchId"), searchKey=$("searchKey");
  const btnFindId=$("btnFindId"), btnFindKey=$("btnFindKey"), btnClear=$("btnClear");
  const dBox=$("detailBox"), d_id=$("d_id"), d_key=$("d_key"), d_banned=$("d_banned"), d_until=$("d_until"), d_reason=$("d_reason"),
        d_rotate=$("d_rotate"), d_ban=$("d_ban"), d_unban=$("d_unban"), d_save=$("d_save"), d_delete=$("d_delete"), detailMsg=$("detailMsg"),
        d_copy_id=$("d_copy_id"), d_copy_key=$("d_copy_key");

  // List & batch
  const btnListAll=$("btnListAll"), btnListBanned=$("btnListBanned"),
        listInfo=$("listInfo"), tbody=$("tbody"), chkAll=$("chkAll"),
        prevPage=$("prevPage"), nextPage=$("nextPage");

  // Prefix search
  const prefixInput=$("prefixInput"), btnSearchPrefix=$("btnSearchPrefix"), btnClearPrefix=$("btnClearPrefix");

  // Admin mgmt
  const adm_uid=$("adm_uid"), adm_add=$("adm_add"), adm_del=$("adm_del"), admMsg=$("admMsg");

  // State
  let ADMIN_OK=false, OWNER_OK=false, CURSOR=null; const PAGE_SIZE=100;

  // Helpers
  const toastEl=$("toast");
  const showToast=(msg)=>{ toastEl.textContent=msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),1600); };
  const setBusy=(el,on)=>{ if(el) el.disabled=!!on; };
  const randKey=()=>{ const abc="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s=""; for(let i=0;i<4;i++) s+=abc[Math.floor(Math.random()*abc.length)]; return s+"-"+Date.now().toString(36).toUpperCase(); };
  const fmtTime=ms=> ms? new Date(ms).toLocaleString(): "";
  async function getAdminFlag(uid){ try{ const snap=await get(ref(db,"admins/"+uid)); return !!snap.val(); }catch{ return false; } }
  const copy = async (txt)=>{ try{ await navigator.clipboard.writeText(String(txt||"")); showToast("Copied"); }catch(e){ showToast("Copy gagal"); } };

  // Auth
  onAuthStateChanged(auth, async (u)=>{
    if(!u){ loginCard.classList.remove("hide"); panelCard.classList.add("hide"); return; }
    meUid.textContent="UID: "+u.uid;
    OWNER_OK = (u.uid===OWNER_UID);
    ADMIN_OK = OWNER_OK || await getAdminFlag(u.uid);
    isOwner.textContent = "Owner: " + (OWNER_OK?"true":"false");
    isAdmin.textContent = "Admin: " + (ADMIN_OK?"true":"false");
    loginCard.classList.add("hide"); panelCard.classList.remove("hide");
    if(!ADMIN_OK) alert("Akun ini belum terdaftar sebagai admin.\nSet /admins/"+u.uid+" = true di Realtime Database.");
    btnListAll.click();
  });

  btnLogin.onclick = async ()=>{
    setBusy(btnLogin,true); loginMsg.textContent="";
    try{ await signInWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value); }
    catch(e){ loginMsg.textContent = e.message || "Login gagal"; }
    finally{ setBusy(btnLogin,false); }
  };
  btnLogout.onclick = ()=>signOut(auth);

  // ===== Add / Create =====
  n_gen.onclick = ()=>{ n_key.value = randKey(); showToast("Key generated"); };
  n_reset.onclick = ()=>{ n_id.value=n_key.value=n_until.value=n_reason.value=""; n_banned.value="false"; addMsg.textContent=""; };
  n_copy_id.onclick = ()=> copy(n_id.value.trim());
  n_copy_key.onclick = ()=> copy(n_key.value.trim());

  n_create.onclick = async ()=>{
    if(!ADMIN_OK){ alert("Bukan admin."); return; }
    const id=n_id.value.trim(); if(!id){ addMsg.textContent="Isi Android ID."; return; }
    const payload={
      key:n_key.value.trim() || randKey(),
      banned:(n_banned.value==="true"),
      until:n_until.value.trim(),
      reason:n_reason.value.trim(),
      updatedAt:Date.now()
    };
    try{
      await set(ref(db,"users/"+id), payload);
      addMsg.textContent="User saved.";
      await loadById(id);
      await actionListAll();
      showToast("Saved");
    }catch(e){ addMsg.textContent="Gagal save: "+(e.message||e); }
  };

  // ===== Detail =====
  function showDetail(id,v){
    d_id.value=id||""; d_key.value=(v&&v.key)||"";
    d_banned.value=String(!!(v&&v.banned));
    d_until.value=(v&&v.until)||""; d_reason.value=(v&&v.reason)||"";
    dBox.classList.remove("hide");
  }
  async function loadById(id){
    if(!id){ detailMsg.textContent="Isi Android ID."; return; }
    try{
      const snap=await get(ref(db,"users/"+id));
      if(!snap.exists()){ detailMsg.textContent="User tidak ditemukan."; dBox.classList.add("hide"); return; }
      showDetail(id, snap.val()); detailMsg.textContent="";
    }catch(e){ detailMsg.textContent="Gagal load: "+(e.message||e); }
  }
  async function loadByKey(key){
    if(!key){ detailMsg.textContent="Isi Key."; return; }
    try{
      const q=query(ref(db,"users"), orderByChild("key"), equalTo(key));
      const snap=await get(q);
      if(!snap.exists()){ detailMsg.textContent="Tidak ada user dengan key tsb."; dBox.classList.add("hide"); return; }
      let id=null,v=null; snap.forEach(ch=>{ if(!id){ id=ch.key; v=ch.val(); }});
      showDetail(id,v); detailMsg.textContent="";
    }catch(e){ detailMsg.textContent="Gagal search key: "+(e.message||e); }
  }
  btnFindId.onclick = ()=> loadById(searchId.value.trim());
  btnFindKey.onclick = ()=> loadByKey(searchKey.value.trim());
  btnClear.onclick   = ()=>{ searchId.value=""; searchKey.value=""; dBox.classList.add("hide"); };

  d_copy_id.onclick = ()=> copy(d_id.value.trim());
  d_copy_key.onclick = ()=> copy(d_key.value.trim());
  d_rotate.onclick=()=>{ d_key.value=randKey(); showToast("Key di-rotate (belum disave)"); };
  d_ban.onclick=()=>{ d_banned.value="true"; if(!d_reason.value) d_reason.value="Violation"; showToast("Marked banned (belum disave)"); };
  d_unban.onclick=()=>{ d_banned.value="false"; d_reason.value=""; d_until.value=""; showToast("Marked unbanned (belum disave)"); };

  d_save.onclick=async ()=>{
    if(!ADMIN_OK){ alert("Bukan admin."); return; }
    const id=d_id.value.trim(); if(!id){ detailMsg.textContent="Tidak ada ID."; return; }
    const payload={ key:d_key.value.trim(), banned:(d_banned.value==="true"),
      until:d_until.value.trim(), reason:d_reason.value.trim(), updatedAt:Date.now() };
    try{
      await update(ref(db,"users/"+id), payload);
      detailMsg.textContent="Saved.";
      await reloadRow(id);  // <— sudah didefinisikan di bawah
      showToast("Saved");
    }catch(e){ detailMsg.textContent="Gagal save: "+(e.message||e); }
  };
  d_delete.onclick=async ()=>{
    if(!ADMIN_OK){ alert("Bukan admin."); return; }
    const id=d_id.value.trim(); if(!id) return;
    if(!confirm("Hapus user "+id+" ?")) return;
    try{ await remove(ref(db,"users/"+id)); detailMsg.textContent="Deleted."; dBox.classList.add("hide"); await actionListAll(); showToast("Deleted"); }
    catch(e){ detailMsg.textContent="Gagal delete: "+(e.message||e); }
  };

  // ===== List & batch =====
  function rowHtml(id,v){
    const ban=v.banned?'<span class="tag-warn">true</span>':'false';
    const up=(v.updatedAt? new Date(v.updatedAt).toLocaleString() : "");
    return `<tr data-id="${id}">
      <td data-label="Select"><input type="checkbox" class="chkRow" data-id="${id}"></td>
      <td data-label="Android ID"><a href="#" class="lnkId link" data-id="${id}">${id}</a></td>
      <td data-label="Key">${(v.key||"")}</td>
      <td data-label="Banned">${ban}</td>
      <td data-label="Until">${v.until||""}</td>
      <td data-label="Updated">${up}</td>
    </tr>`;
  }
  function bindRowClicks(){ document.querySelectorAll(".lnkId").forEach(a=>{ a.onclick=(e)=>{ e.preventDefault(); loadById(a.dataset.id); }; }); }

  async function listByKey(startKey=null){
    const q = startKey? query(ref(db,"users"), orderByKey(), startAt(startKey), limitToFirst(PAGE_SIZE+1))
                      : query(ref(db,"users"), orderByKey(), limitToFirst(PAGE_SIZE));
    const snap=await get(q); const rows=[]; let skipFirst=!!startKey;
    snap.forEach(ch=>{ if(skipFirst && ch.key===startKey){ skipFirst=false; return; } rows.push([ch.key,ch.val()]); });
    return rows;
  }
  async function listBanned(){
    const q=query(ref(db,"users"), orderByChild("banned"), equalTo(true), limitToFirst(PAGE_SIZE));
    const snap=await get(q); const rows=[]; snap.forEach(ch=> rows.push([ch.key,ch.val()])); return rows;
  }
  async function listByIdPrefix(prefix){
    const q = query(ref(db,"users"), orderByKey(), startAt(prefix), endAt(prefix + "\uf8ff"), limitToFirst(PAGE_SIZE));
    const snap=await get(q); const rows=[]; snap.forEach(ch=> rows.push([ch.key,ch.val()])); return rows;
  }
  async function renderRows(rows){
    listInfo.textContent=`${rows.length} items`;
    const html = rows.length? rows.map(([id,v])=>rowHtml(id,v)).join("") : `<tr><td colspan="6" class="muted">Belum ada data.</td></tr>`;
    tbody.innerHTML=html; bindRowClicks();
  }
  async function actionListAll(){ const rows=await listByKey(CURSOR); await renderRows(rows); }
  async function actionListBanned(){ CURSOR=null; const rows=await listBanned(); await renderRows(rows); }

  // reloadRow — FIX untuk error yang kamu lihat
  async function reloadRow(id){
    const tr = tbody.querySelector(`tr[data-id="${id}"]`);
    try{
      const snap=await get(ref(db,"users/"+id));
      if(!snap.exists()){ if(tr) tr.remove(); return; }
      const v=snap.val();
      if(tr){
        tr.outerHTML = rowHtml(id,v);
        bindRowClicks();
      }else{
        // kalau row tidak sedang di halaman, refresh list saja
        await actionListAll();
      }
    }catch(e){
      console.error("reloadRow gagal:", e);
    }
  }

  btnListAll.onclick=actionListAll; btnListBanned.onclick=actionListBanned;

  // Simple paging: next = ambil lanjut dari last key; prev = reset
  nextPage.onclick=async ()=>{
    const last=tbody.querySelector("tr:last-child"); if(!last) return;
    CURSOR = last.dataset.id; await actionListAll();
  };
  prevPage.onclick=async ()=>{ CURSOR=null; await actionListAll(); };

  // Prefix search (dengan debounce biar ramah ketik)
  let tDeb=null;
  const doPrefix = async ()=>{
    const p = prefixInput.value.trim();
    if(!p){ await actionListAll(); return; }
    const rows = await listByIdPrefix(p); await renderRows(rows);
  };
  btnSearchPrefix.onclick = doPrefix;
  btnClearPrefix.onclick = async ()=>{ prefixInput.value=""; await actionListAll(); };
  prefixInput.addEventListener("input", ()=>{ clearTimeout(tDeb); tDeb=setTimeout(doPrefix, 280); });

  // Select all & batch ops
  chkAll.onchange=()=>{ document.querySelectorAll(".chkRow").forEach(c=> c.checked=chkAll.checked); };
  const selectedIds=()=>{ const ids=[]; document.querySelectorAll(".chkRow:checked").forEach(c=> ids.push(c.dataset.id)); return ids; };

  async function batchUpdate(field,value){
    if(!ADMIN_OK){ alert("Bukan admin."); return; }
    const ids=selectedIds(); if(!ids.length) return alert("Pilih item dulu.");
    if(!confirm(`Set ${field}=${value} untuk ${ids.length} user?`)) return;
    const now=Date.now(); await Promise.allSettled(ids.map(id=> update(ref(db,"users/"+id), { [field]:value, updatedAt:now })));
    await actionListAll(); showToast("Batch applied");
  }
  async function batchDeleteFn(){
    if(!ADMIN_OK){ alert("Bukan admin."); return; }
    const ids=selectedIds(); if(!ids.length) return alert("Pilih item dulu.");
    if(!confirm(`Hapus ${ids.length} user?`)) return;
    await Promise.allSettled(ids.map(id=> remove(ref(db,"users/"+id)))); await actionListAll(); showToast("Batch deleted");
  }
  $("batchBan").onclick=()=>batchUpdate("banned",true);
  $("batchUnban").onclick=()=>batchUpdate("banned",false);
  $("batchDelete").onclick=batchDeleteFn;

  // Admin management (OWNER only)
  async function setAdmin(uid,val){
    if(!OWNER_OK){ admMsg.textContent="Hanya OWNER."; return; }
    if(!uid){ admMsg.textContent="Isi UID."; return; }
    try{ await set(ref(db,"admins/"+uid), !!val); admMsg.textContent=(val?"Granted":"Revoked")+" for "+uid; setTimeout(()=>admMsg.textContent="",2000); showToast("Admin updated"); }
    catch(e){ admMsg.textContent="Gagal: "+(e.message||e); }
  }
  $("adm_add").onclick=()=>setAdmin(adm_uid.value.trim(),true);
  $("adm_del").onclick=()=>setAdmin(adm_uid.value.trim(),false);

  // QoL: enter untuk cari, Ctrl/⌘+K fokus search
  searchId.addEventListener("keydown", e=>{ if(e.key==="Enter") btnFindId.click(); });
  searchKey.addEventListener("keydown", e=>{ if(e.key==="Enter") btnFindKey.click(); });
  window.addEventListener("keydown", e=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){ e.preventDefault(); prefixInput.focus(); }
  });
</script>
</body>
</html>
