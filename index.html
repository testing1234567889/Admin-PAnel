<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>GxMods Admin Panel</title>
  <style>
    :root{
      --bg:#0f1115; --card:#141821; --muted:#1b2030; --stroke:#273043;
      --txt:#e9eef5; --hint:#9aa7b4; --pri:#2188ff; --pri-2:#166ad9;
      --ok:#2eb872; --warn:#ef5350; --pill:#213042; --pillTxt:#cce7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:20px auto;padding:0 12px}
    .card{background:linear-gradient(180deg,rgba(33,136,255,.12),transparent),var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:980px){.row{grid-template-columns:1fr}}
    h2{margin:4px 0 14px 0;font-weight:700;font-size:18px}
    label{display:block;margin:10px 0 6px 2px;color:var(--hint);font-size:12px}
    input,select,textarea{width:100%;background:var(--muted);border:1px solid var(--stroke);color:var(--txt);border-radius:12px;padding:12px 12px;font-size:14px;outline:none}
    textarea{min-height:76px;resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:999px;border:1px solid var(--stroke);padding:10px 16px;min-height:42px;cursor:pointer;user-select:none;gap:8px}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn--pri{background:var(--pri);border-color:#1c7be8;color:#fff}
    .btn--ghost{background:transparent}
    .btn--warn{background:var(--warn);border-color:#b00020;color:#fff}
    .btn--ok{background:var(--ok);border-color:#1d8a55;color:#fff}
    .btn--muted{background:#222a3a;border-color:var(--stroke);color:#ccd6e0}
    .btn-sm{padding:6px 10px;min-height:34px;border-radius:14px;font-size:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .tag{background:#1b2536;color:#c7d7ff;border:1px solid #2a3955;padding:6px 10px;border-radius:999px;font-size:12px}
    .right{margin-left:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:12px}
    thead th{font-size:12px;color:var(--hint);text-align:left}
    tbody tr{background:var(--muted);border:1px solid var(--stroke)}
    tbody tr td{border-top:1px solid var(--stroke);border-bottom:1px solid var(--stroke)}
    tbody tr td:first-child{border-left:1px solid var(--stroke);border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-right:1px solid var(--stroke);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .table-wrap{overflow:auto;max-height:60vh;padding-bottom:6px}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1}
    .pill{background:var(--pill);color:var(--pillTxt);padding:8px 12px;border-radius:999px;border:1px solid #2a3c59;font-size:12px}
    .space{height:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:560px){.grid2{grid-template-columns:1fr}}
    .hl{color:#bfe1ff}
    .copy{font-size:12px}
    .danger{color:#ffb4ba}
    .ok{color:#b5ffd1}
    .hint{color:var(--hint)}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#1b2536;color:#dfe8f6;border:1px solid #2a3955;border-radius:12px;padding:10px 14px;z-index:99;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1;pointer-events:auto}
    /* buttons dock for mobile bulk actions */
    .dock{position:sticky;bottom:0;display:flex;gap:10px;justify-content:center;padding:10px 0;background:linear-gradient(180deg, transparent, rgba(0,0,0,.35))}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="hdr">
      <div class="toolbar">
        <div class="tag">UID: <span id="meUid">-</span></div>
        <div class="tag">Admin: <span id="meAdmin">false</span></div>
        <div class="tag">Owner: <span id="meOwner">false</span></div>
        <div class="right flex">
          <input id="email" placeholder="email admin" style="width:200px">
          <input id="pass" type="password" placeholder="password" style="width:160px">
          <button id="loginBtn" class="btn btn--pri">Login</button>
          <button id="logoutBtn" class="btn btn--ghost">Logout</button>
        </div>
      </div>
    </div>

    <div class="space"></div>

    <div class="row">
      <!-- ADD / EDIT -->
      <div class="card">
        <h2>Add / Edit User</h2>
        <label>Android ID</label>
        <div class="flex">
          <input id="f_id" class="grow" placeholder="contoh: a1b2c3d4e5f6abcd" autocomplete="off">
          <button class="btn btn-sm btn--muted" id="copyId">Copy</button>
        </div>

        <label>Key</label>
        <div class="flex">
          <input id="f_key" class="grow" placeholder="ZXCV-9999-PAID" autocomplete="off">
          <button class="btn btn-sm btn--muted" id="genKey">Generate</button>
          <button class="btn btn-sm btn--muted" id="copyKey">Copy</button>
        </div>

        <label>Banned</label>
        <select id="f_banned">
          <option value="false">false</option>
          <option value="true">true</option>
        </select>

        <label>Until (dd-MM-yyyy atau epoch/ms, kosongkan jika tidak)</label>
        <input id="f_until" placeholder="25-12-2025 atau 1735100000000">

        <label>Reason (opsional)</label>
        <textarea id="f_reason" placeholder="opsional"></textarea>

        <div class="space"></div>
        <div class="toolbar">
          <button id="btnSave" class="btn btn--pri">Create / Overwrite</button>
          <button id="btnReset" class="btn btn--ghost">Reset</button>
        </div>

        <div class="space"></div>
        <h2>Search / Detail</h2>
        <div class="grid2">
          <div>
            <label>Android ID (exact)</label>
            <div class="flex">
              <input id="q_id" class="grow" placeholder="android id lengkap">
              <button id="btnFindId" class="btn btn-sm btn--muted">Find by ID</button>
            </div>
          </div>
          <div>
            <label>Key (exact)</label>
            <div class="flex">
              <input id="q_key" class="grow" placeholder="key lengkap">
              <button id="btnFindKey" class="btn btn-sm btn--muted">Find by Key</button>
              <button id="btnClear" class="btn btn-sm btn--ghost">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <!-- LIST -->
      <div class="card">
        <h2>Users List</h2>
        <div class="toolbar">
          <button id="btnList" class="btn btn--muted">List (100)</button>
          <button id="btnListBanned" class="btn btn--muted">List Banned</button>
          <input id="q_prefix" class="grow" placeholder="Cari prefix Android ID (mis. a1b2)">
          <button id="btnSearchPrefix" class="btn btn--muted">Search Prefix</button>
          <button id="btnClrPrefix" class="btn btn--ghost">Clear</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:40px">Sel</th>
                <th>Android ID</th>
                <th>Key</th>
                <th>Banned</th>
                <th>Until</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="toolbar">
          <button id="btnPrev" class="btn btn-sm btn--ghost">Prev</button>
          <button id="btnNext" class="btn btn-sm btn--ghost">Next</button>
          <div class="right hint" id="countInfo"></div>
        </div>

        <div class="dock">
          <button id="btnBanSel" class="btn btn--warn">Ban Selected</button>
          <button id="btnUnbanSel" class="btn btn--ok">Unban Selected</button>
          <button id="btnDelSel" class="btn btn--warn">Delete Selected</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    // ====== CONFIG ======
    const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3"; // punyamu
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
      authDomain: "animeplay-738a4.firebaseapp.com",
      databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
      projectId: "animeplay-738a4",
      storageBucket: "animeplay-738a4.firebasestorage.app",
      messagingSenderId: "129738568083",
      appId: "1:129738568083:web:d144ad8d1a66d893213866",
      measurementId: "G-J6G96TPMHX"
    };

    // ====== SDK v9 (modular) via CDN ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, child, get, set, update, remove, query, orderByKey, startAt, endAt, limitToFirst } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ====== STATE ======
    const S = {
      me: { uid: null, isOwner: false, isAdmin: false },
      list: [], sel: new Set(), cursorStart: null, lastKey: null, bannedOnly: false, prefix: null
    };

    // ====== HELPERS ======
    const $ = sel => document.querySelector(sel);
    const toast = (msg, ms=1600)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); };
    const fmtTime = ms => { if(!ms) return ""; const d=new Date(ms); const dd=String(d.getDate()).padStart(2,"0"); const mm=String(d.getMonth()+1).padStart(2,"0"); const yy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,"0"); const mi=String(d.getMinutes()).padStart(2,"0"); const ss=String(d.getSeconds()).padStart(2,"0"); return `${dd}/${mm}/${yy}, ${hh}.${mi}.${ss}` };
    const parseUntil = v => {
      if(!v) return "";
      v = String(v).trim();
      if(/^\d{10}$/.test(v)) return Number(v)*1000;
      if(/^\d{13}$/.test(v)) return Number(v);
      // dd-MM-yyyy
      const m = v.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if(m){ const [_,d,mo,y]=m; return new Date(`${y}-${mo}-${d}T00:00:00Z`).getTime(); }
      return v; // simpan mentah kalau user pakai format lain
    };
    const isBannedNow = (banned, until)=>{
      if(!banned) return false;
      if(!until) return true;
      const u = parseUntil(until);
      return typeof u === "number" ? (Date.now() <= u) : true;
    };
    const ensureAdminWrite = ()=>{
      if(!S.me.uid){ toast("Login dulu."); throw 0; }
      if(!S.me.isAdmin){ toast("Akses tulis butuh admin."); throw 0; }
    };

    // ====== AUTH ======
    const updateBadges = async ()=>{
      $("#meUid").textContent = S.me.uid ?? "-";
      $("#meOwner").textContent = S.me.isOwner;
      // cek admin flag di /admins/{uid}
      let admin = false;
      if(S.me.uid){
        try{
          const snap = await get(ref(db, `admins/${S.me.uid}`));
          admin = snap.exists() ? !!snap.val() : false;
        }catch(e){ admin = false; }
      }
      S.me.isAdmin = S.me.isOwner || admin;
      $("#meAdmin").textContent = S.me.isAdmin;
    };

    onAuthStateChanged(auth, async (u)=>{
      S.me.uid = u?.uid || null;
      S.me.isOwner = (u?.uid === OWNER_UID);
      await updateBadges();
    });

    $("#loginBtn").onclick = async ()=>{
      const email = $("#email").value.trim();
      const pass = $("#pass").value.trim();
      if(!email || !pass){ toast("Isi email & password."); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast("Login sukses.");
      }catch(e){
        console.error(e); toast("Login gagal: "+(e.code||e.message));
      }
    };
    $("#logoutBtn").onclick = async ()=>{ try{ await signOut(auth); toast("Logout."); }catch{} };

    // ====== CRUD ======
    const readUser = async (aid)=>{
      const snap = await get(ref(db, `users/${aid}`));
      return snap.exists()? snap.val() : null;
    };

    const writeUser = async (aid, data)=>{
      ensureAdminWrite();
      const payload = {
        key: (data.key||"").trim(),
        banned: !!data.banned,
        until: data.until??"",
        reason: (data.reason||"").trim(),
        updatedAt: Date.now()
      };
      await set(ref(db, `users/${aid}`), payload);
      toast("Tersimpan.");
    };

    const deleteUsers = async (ids)=>{
      ensureAdminWrite();
      const multi = {};
      ids.forEach(id => multi[`users/${id}`] = null);
      await update(ref(db), multi);
      toast(`Hapus ${ids.length} user.`);
    };

    const setBanBulk = async (ids, banned)=>{
      ensureAdminWrite();
      const multi = {};
      ids.forEach(id => {
        multi[`users/${id}/banned`] = !!banned;
        multi[`users/${id}/updatedAt`] = Date.now();
      });
      await update(ref(db), multi);
      toast(`${banned? "Di-ban" : "Di-unban"} ${ids.length} user.`);
    };

    // ====== LIST/PAGINATION ======
    async function fetchList({prefix=null, bannedOnly=false, startKey=null, limit=100}={}){
      let q;
      if(prefix){
        const end = prefix + "\uf8ff";
        q = query(ref(db, "users"), orderByKey(), startAt(startKey||prefix), endAt(end), limitToFirst(limit+1));
      }else{
        q = query(ref(db, "users"), orderByKey(), startAt(startKey||""), limitToFirst(limit+1));
      }
      const snap = await get(q);
      const all = [];
      snap.forEach(ch => {
        const id = ch.key;
        const v = ch.val() || {};
        if(!bannedOnly || isBannedNow(!!v.banned, v.until)) {
          all.push({ id, ...v });
        }
      });
      // simple cursor
      let nextStart = null;
      if(all.length > limit){
        const last = all.pop();
        nextStart = last.id;
      }
      return {rows: all, nextStart};
    }

    function renderRows(rows){
      const tb = $("#tbody");
      tb.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" data-id="${r.id}"></td>
          <td><a href="#" class="hl fill" data-id="${r.id}">${r.id}</a></td>
          <td class="mono">${(r.key||"")}</td>
          <td class="${r.banned? "danger":"ok"}">${r.banned}</td>
          <td>${r.until||""}</td>
          <td class="hint">${fmtTime(r.updatedAt)}</td>
        `;
        tb.appendChild(tr);
      });
      // bind checkbox
      S.sel.clear();
      tb.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.onchange = (e)=>{
          const id = e.target.getAttribute("data-id");
          if(e.target.checked) S.sel.add(id); else S.sel.delete(id);
        };
      });
      // bind click fill to the form
      tb.querySelectorAll('a.fill').forEach(a=>{
        a.onclick = async (e)=>{
          e.preventDefault();
          const id = a.getAttribute("data-id");
          const v = await readUser(id);
          fillForm(id, v);
        };
      });
      $("#countInfo").textContent = `${rows.length} items`;
    }

    function fillForm(id, v){
      $("#f_id").value = id || "";
      $("#f_key").value = v?.key || "";
      $("#f_banned").value = v?.banned? "true":"false";
      $("#f_until").value = v?.until || "";
      $("#f_reason").value = v?.reason || "";
    }

    async function doList(firstPage=true){
      const {prefix, bannedOnly} = S;
      const {rows, nextStart} = await fetchList({prefix, bannedOnly, startKey:firstPage? (prefix||"") : S.cursorStart});
      S.list = rows;
      S.cursorStart = nextStart;
      renderRows(rows);
    }

    // ====== UI EVENTS ======
    $("#btnSave").onclick = async ()=>{
      try{
        const aid = $("#f_id").value.trim();
        const key = $("#f_key").value.trim();
        if(!aid || !key){ toast("Android ID & Key wajib."); return; }
        await writeUser(aid, {
          key,
          banned: $("#f_banned").value === "true",
          until: $("#f_until").value.trim(),
          reason: $("#f_reason").value.trim()
        });
        await doList(true);
      }catch(e){ if(e) console.error(e); }
    };
    $("#btnReset").onclick = ()=> fillForm("", {key:"",banned:false,until:"",reason:""});

    $("#btnFindId").onclick = async ()=>{
      const id = $("#q_id").value.trim();
      if(!id){ toast("Isi Android ID."); return; }
      const v = await readUser(id);
      if(!v){ toast("Tidak ditemukan."); return; }
      fillForm(id, v);
    };

    $("#btnFindKey").onclick = async ()=>{
      const target = $("#q_key").value.trim();
      if(!target){ toast("Isi key."); return; }
      // scan cepat 1000 pertama (kalau user banyak, pakai paging manual)
      const {rows} = await fetchList({prefix:null, bannedOnly:false, startKey:"", limit:1000});
      const hit = rows.find(r => (r.key||"") === target);
      if(!hit){ toast("Key tidak ditemukan di batch ini."); return; }
      fillForm(hit.id, hit);
    };

    $("#btnClear").onclick = ()=>{ $("#q_id").value=""; $("#q_key").value=""; };

    $("#btnList").onclick = async ()=>{ S.prefix=null; S.bannedOnly=false; S.cursorStart=null; await doList(true); };
    $("#btnListBanned").onclick = async ()=>{ S.prefix=null; S.bannedOnly=true; S.cursorStart=null; await doList(true); };
    $("#btnSearchPrefix").onclick = async ()=>{ S.prefix = ($("#q_prefix").value||"").trim(); S.bannedOnly=false; S.cursorStart=null; await doList(true); };
    $("#btnClrPrefix").onclick = async ()=>{ $("#q_prefix").value=""; S.prefix=null; S.cursorStart=null; await doList(true); };

    $("#btnPrev").onclick = async ()=>{ toast("Pagination sederhana: hanya Next (cursor forward)."); };
    $("#btnNext").onclick = async ()=>{ if(!S.cursorStart){ toast("Sudah terakhir."); return; } await doList(false); };

    $("#btnBanSel").onclick = async ()=>{ if(S.sel.size===0){ toast("Pilih dulu."); return; } await setBanBulk(Array.from(S.sel), true); await doList(true); };
    $("#btnUnbanSel").onclick = async ()=>{ if(S.sel.size===0){ toast("Pilih dulu."); return; } await setBanBulk(Array.from(S.sel), false); await doList(true); };
    $("#btnDelSel").onclick = async ()=>{ if(S.sel.size===0){ toast("Pilih dulu."); return; } if(!confirm("Hapus selected?")) return; await deleteUsers(Array.from(S.sel)); await doList(true); };

    $("#copyId").onclick = ()=>{ navigator.clipboard.writeText($("#f_id").value||""); toast("Android ID disalin."); };
    $("#copyKey").onclick = ()=>{ navigator.clipboard.writeText($("#f_key").value||""); toast("Key disalin."); };
    $("#genKey").onclick = ()=>{
      // Key simple: 4 alphanum - 4 digit - SUFFIX
      const part = (n,chars)=>Array.from(crypto.getRandomValues(new Uint8Array(n))).map(b=>chars[b%chars.length]).join('');
      const k = `${part(4,"ABCDEFGHJKLMNPQRSTUVWXYZ")}-${part(4,"0123456789")}-PAID`;
      $("#f_key").value = k;
    };

    // auto-refresh list setelah login
    setTimeout(()=>doList(true), 600);
  </script>
</body>
</html>
