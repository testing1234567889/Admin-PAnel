
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GxMods Admin Panel</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <style>
    :root {
      --bg: #0f1320;
      --card: #151a2b;
      --muted: #a7b0c0;
      --text: #eaf0ff;
      --accent: #66b2ff;
      --ok: #24c17a;
      --danger: #ff5d5d;
      --stroke: #27304a;
      --chip: #1c2236;
      --chip-text: #c8d2ea;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      -webkit-font-smoothing: antialiased;
      line-height: 1.35;
    }
    .wrap { max-width: 1100px; margin: 16px auto 80px; padding: 0 12px; }
    .bar {
      display: grid; gap: 8px; align-items: center;
      grid-template-columns: 1fr auto;
      background: var(--card); border: 1px solid var(--stroke);
      border-radius: 14px; padding: 12px;
      position: sticky; top: 0; z-index: 20; backdrop-filter: blur(6px);
    }
    .row { display: grid; gap: 12px; }
    @media (min-width: 900px) { .row.two { grid-template-columns: 1fr 1fr; } }
    .card {
      background: var(--card); border: 1px solid var(--stroke);
      border-radius: 16px; padding: 14px;
    }
    h2 { font-size: 18px; margin: 0 0 10px; }
    .chip { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; background:var(--chip); color:var(--chip-text); border:1px solid var(--stroke); border-radius:999px; font-size:12px; }
    .grid { display:grid; gap:10px; }
    .label { font-size:12px; color:var(--muted); }
    input, select, textarea { width:100%; background:#0d1220; color:var(--text); border:1px solid var(--stroke); border-radius:12px; padding:12px; outline:none; }
    input::placeholder, textarea::placeholder { color:#7782a1; }
    textarea { min-height:64px; resize:vertical; }
    .btn { user-select:none; border:none; border-radius:999px; padding:12px 18px; font-weight:600; cursor:pointer; transition:transform .04s ease; }
    .btn:active { transform: translateY(1px); }
    .btn.ok { background:var(--ok); color:#041814; }
    .btn.warn { background:var(--danger); color:#190a0a; }
    .btn.ghost { background:transparent; border:1px solid var(--stroke); color:var(--text); }
    .btn.accent { background:var(--accent); color:#001626; }
    .btn.block { width:100%; }
    .row-actions { display:flex; gap:8px; }
    .table { width:100%; border-collapse:collapse; }
    .thead, .row-item { display:grid; grid-template-columns: 1.2fr 1fr .8fr .9fr .6fr; gap:8px; padding:10px; align-items:center; }
    .thead { color:var(--muted); font-size:12px; }
    .row-item { border-top:1px solid var(--stroke); }
    .muted { color:var(--muted); }
    .inline { display:flex; gap:10px; }
    .inline > * { flex:1; }
    .actions { display:flex; gap:10px; justify-content:space-between; }
    .hr { height:1px; background:var(--stroke); margin:12px 0; }
    .k { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .empty { padding:14px; color:var(--muted); }
    .right { text-align:right; }
    .hide { display:none !important; }
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 14px; background:#0b1020; border:1px solid var(--stroke);
      color:var(--text); padding:10px 14px; border-radius:12px; font-size:13px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35); z-index: 999;
    }
    /* Mobile tweaks */
    @media (max-width: 520px){
      .thead, .row-item { grid-template-columns: 1.2fr 1fr .7fr .9fr .6fr; }
      .bar { grid-template-columns: 1fr; gap:10px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="inline">
      <span class="chip" id="chipUid">UID: -</span>
      <span class="chip" id="chipAdmin">Admin:false</span>
      <span class="chip" id="chipOwner">Owner:false</span>
    </div>
    <div id="authBox" class="inline">
      <input id="email" placeholder="email admin" autocomplete="username" />
      <input id="password" type="password" placeholder="password" autocomplete="current-password" />
      <button class="btn accent" id="btnLogin">Login</button>
      <button class="btn ghost hide" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="row two" style="margin-top:12px">
    <div class="card">
      <h2>Buat / Ubah User</h2>
      <div class="grid">
        <div>
          <div class="label">Android ID</div>
          <input id="aid" placeholder="contoh: a1b2c3d4e5f6abcd" class="k" />
        </div>
        <div>
          <div class="label">Key</div>
          <input id="akey" placeholder="contoh: ZXCV-5R3K-PAID" class="k" />
        </div>
        <div>
          <div class="label">Alasan (opsional)</div>
          <input id="reason" placeholder="Misal: Abuse" />
        </div>
        <div class="inline">
          <div>
            <div class="label">Sampai (opsional, 25-12-2025 / 1735171200000)</div>
            <input id="until" placeholder="dd-mm-yyyy ATAU epoch(ms)" />
          </div>
          <div>
            <div class="label">Banned</div>
            <select id="banned">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button class="btn ok block" id="btnSave">Simpan</button>
          <button class="btn warn block" id="btnDelete">Hapus</button>
        </div>
        <div class="muted">Kolom “Android ID” & “Key” wajib. Tanpa tombol copy & tanpa generate sesuai permintaan.</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between">
        <h2>Users List</h2>
        <button id="btnLogout2" class="btn ghost hide">Logout</button>
      </div>
      <div class="grid">
        <div>
          <div class="label">Pencarian (Android ID penuh)</div>
          <input id="qExact" placeholder="tempel Android ID untuk cari 1 user" class="k" />
        </div>
        <div>
          <div class="label">Search Prefix</div>
          <div class="inline">
            <input id="qPrefix" placeholder="misal: a1b2" class="k" />
            <button class="btn ghost" id="btnSearch">Search</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="thead">
        <div>Android ID</div>
        <div>Key</div>
        <div>Banned</div>
        <div>Until</div>
        <div class="right">Aksi</div>
      </div>
      <div id="list"></div>

      <div id="empty" class="empty hide">Belum ada data user yang dimuat.</div>

      <div class="hr"></div>
      <button class="btn ghost block" id="btnMore">Muat lebih</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Kelola Admin (Owner saja)</h2>
    <div class="grid">
      <div>
        <div class="label">UID</div>
        <input id="admUid" placeholder="tempel UID untuk grant / revoke" class="k" />
      </div>
      <div class="inline">
        <button class="btn ok block" id="btnGrant">Grant Admin</button>
        <button class="btn warn block" id="btnRevoke">Revoke Admin</button>
      </div>
      <div class="muted k">Owner: SjEQCMqzEMb2PQclx8Iidde3reA3</div>
    </div>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<script type="module">
  // ==== Firebase (modular v10) ====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getDatabase, ref, get, set, remove, child, query, orderByKey, startAt, endAt, limitToFirst } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
    authDomain: "animeplay-738a4.firebaseapp.com",
    databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
    projectId: "animeplay-738a4",
    storageBucket: "animeplay-738a4.firebasestorage.app",
    messagingSenderId: "129738568083",
    appId: "1:129738568083:web:d144ad8d1a66d893213866",
    measurementId: "G-J6G96TPMHX"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";

  // ==== DOM ====
  const el = (id) => document.getElementById(id);
  const t = el("toast");
  const toast = (msg) => { t.textContent = msg; t.classList.remove("hide"); clearTimeout(window.__t); window.__t=setTimeout(()=>t.classList.add("hide"), 2400); };

  const chipUid = el("chipUid");
  const chipAdmin = el("chipAdmin");
  const chipOwner = el("chipOwner");
  const authBox = el("authBox");
  const btnLogin = el("btnLogin");
  const btnLogout = el("btnLogout");
  const btnLogout2 = el("btnLogout2");
  const email = el("email");
  const password = el("password");

  const aid = el("aid"); const akey = el("akey");
  const bannedSel = el("banned"); const until = el("until"); const reason = el("reason");
  const btnSave = el("btnSave"); const btnDelete = el("btnDelete");

  const qExact = el("qExact"); const qPrefix = el("qPrefix");
  const btnSearch = el("btnSearch"); const list = el("list");
  const btnMore = el("btnMore"); const empty = el("empty");

  const admUid = el("admUid"); const btnGrant = el("btnGrant"); const btnRevoke = el("btnRevoke");

  // ==== State ====
  let isAdmin = false;
  let isOwner = false;
  let currentUid = null;

  let PAGE = { size: 20, anchor: null, prefix: "" };

  const BAD_KEY_CHARS = /[.#$\[\]/]/;

  function isValidKeyFragment(s) {
    return typeof s === "string" && s.length > 0 && !BAD_KEY_CHARS.test(s);
  }

  function fmt(v) { return v==null? "" : String(v); }

  function vObj(key, val) {
    // Normalisasi node user (string -> object)
    if (val == null) return { key: "", banned: false, until: "", reason: "", updatedAt: Date.now() };
    if (typeof val === "string") return { key: val, banned: false, until: "", reason: "", updatedAt: Date.now() };
    return {
      key: fmt(val.key),
      banned: Boolean(val.banned),
      until: fmt(val.until),
      reason: fmt(val.reason),
      updatedAt: Number(val.updatedAt || Date.now())
    };
  }

  function rowTemplate(aid, v) {
    const id = "r_"+aid.replace(/[^a-zA-Z0-9_-]/g,"_");
    return `
      <div class="row-item" id="${id}">
        <div class="k">${aid}</div>
        <div><input class="k" id="${id}_key" value="${v.key}"/></div>
        <div>
          <select id="${id}_ban">
            <option value="false" ${v.banned? "": "selected"}>false</option>
            <option value="true"  ${v.banned? "selected": ""}>true</option>
          </select>
        </div>
        <div><input id="${id}_until" placeholder="dd-mm-yyyy / epoch" value="${v.until}"/></div>
        <div class="right row-actions">
          <button class="btn ok" onclick="window.__save('${aid}')">Save</button>
          <button class="btn warn" onclick="window.__del('${aid}')">Del</button>
        </div>
      </div>`;
  }

  function renderList(items, append=false) {
    if (!append) list.innerHTML = "";
    for (const it of items) {
      list.insertAdjacentHTML("beforeend", rowTemplate(it.aid, it.v));
    }
    empty.classList.toggle("hide", list.children.length > 0);
  }

  // Expose save/del for inline buttons
  window.__save = async function(a) {
    if (!isAdmin) return toast("Hanya admin yang bisa menulis.");
    const id = "r_"+a.replace(/[^a-zA-Z0-9_-]/g,"_");
    const v = {
      key: document.getElementById(id+"_key").value.trim(),
      banned: document.getElementById(id+"_ban").value === "true",
      until: document.getElementById(id+"_until").value.trim(),
      reason: "", // inline row tidak tampil reason, simple
      updatedAt: Date.now()
    };
    if (!isValidKeyFragment(a) || !v.key) return toast("Android ID / Key tidak valid.");
    await set(ref(db, "users/"+a), v);
    toast("Tersimpan.");
  }
  window.__del = async function(a) {
    if (!isAdmin) return toast("Hanya admin yang bisa menulis.");
    if (!confirm("Hapus user "+a+" ?")) return;
    await remove(ref(db, "users/"+a));
    document.getElementById("r_"+a.replace(/[^a-zA-Z0-9_-]/g,"_"))?.remove();
    empty.classList.toggle("hide", list.children.length > 0);
    toast("Terhapus.");
  }

  async function checkAdmin(uid) {
    if (!uid) return false;
    const snap = await get(ref(db, "admins/"+uid));
    return snap.exists() && snap.val() === true;
  }

  function setAuthUI(uid, admin, owner) {
    chipUid.textContent = "UID: " + (uid || "-");
    chipAdmin.textContent = "Admin:" + (admin? "true":"false");
    chipOwner.textContent = "Owner:" + (owner? "true":"false");
    // Sembunyikan login ketika sudah login
    const loggedIn = !!uid;
    btnLogout.classList.toggle("hide", !loggedIn);
    btnLogout2.classList.toggle("hide", !loggedIn);
    btnLogin.classList.toggle("hide", loggedIn);
    email.classList.toggle("hide", loggedIn);
    password.classList.toggle("hide", loggedIn);
  }

  // Pagination query builder
  async function loadPage({ reset=false }={}) {
    try {
      if (reset) PAGE.anchor = null;
      const items = [];
      const base = ref(db, "users");
      const exact = qExact.value.trim();
      const prefix = qPrefix.value.trim();

      if (exact) {
        // exact find wins, ignore pagination
        const s = await get(child(base, exact));
        if (s.exists()) items.push({ aid: exact, v: vObj(exact, s.val()) });
        renderList(items, false);
        btnMore.disabled = true;
        return;
      }

      // Build query
      let lim = PAGE.size + (PAGE.anchor? 1 : 0);
      let q = query(base, orderByKey());

      if (prefix) {
        if (!isValidKeyFragment(prefix)) {
          toast("Prefix tidak valid. Hindari . # $ [ ] /");
          return;
        }
        q = query(q, startAt(prefix), endAt(prefix + "\uf8ff"));
      }
      if (PAGE.anchor) {
        q = query(q, startAt(PAGE.anchor));
      }
      q = query(q, limitToFirst(lim));

      const snap = await get(q);
      if (!snap.exists()) {
        if (!PAGE.anchor) renderList([], false);
        btnMore.disabled = true;
        return;
      }

      const arr = [];
      snap.forEach(ch => {
        arr.push({ aid: ch.key, v: vObj(ch.key, ch.val()) });
      });

      // drop duplicate when startAt(anchor)
      const startIdx = PAGE.anchor? 1 : 0;
      const pageData = arr.slice(startIdx, startIdx + PAGE.size);

      if (reset) renderList(pageData, false); else renderList(pageData, true);

      // next anchor
      PAGE.anchor = pageData.length? pageData[pageData.length-1].aid : PAGE.anchor;
      btnMore.disabled = pageData.length < PAGE.size;
    } catch (e) {
      console.error(e);
      toast("Gagal memuat data.");
    }
  }

  // Save / Delete from form
  btnSave.onclick = async () => {
    if (!isAdmin) return toast("Hanya admin yang bisa menulis.");
    const a = aid.value.trim();
    const k = akey.value.trim();
    if (!isValidKeyFragment(a) || !k) return toast("Android ID / Key tidak valid.");
    const v = {
      key: k,
      banned: bannedSel.value === "true",
      until: until.value.trim(),
      reason: reason.value.trim(),
      updatedAt: Date.now()
    };
    await set(ref(db, "users/"+a), v);
    toast("Disimpan.");
    PAGE.prefix = "";
    qPrefix.value = "";
    qExact.value = "";
    await loadPage({ reset: true });
  };
  btnDelete.onclick = async () => {
    if (!isAdmin) return toast("Hanya admin yang bisa menulis.");
    const a = aid.value.trim();
    if (!isValidKeyFragment(a)) return toast("Android ID tidak valid.");
    await remove(ref(db, "users/"+a));
    toast("Dihapus.");
    await loadPage({ reset: true });
  };

  // Search
  btnSearch.onclick = async () => {
    PAGE.anchor = null;
    await loadPage({ reset: true });
  };
  btnMore.onclick = () => loadPage();

  // Admin Mgmt
  btnGrant.onclick = async () => {
    if (!isOwner) return toast("Hanya owner.");
    const u = admUid.value.trim(); if (!u) return;
    await set(ref(db, "admins/"+u), true);
    toast("Granted.");
  };
  btnRevoke.onclick = async () => {
    if (!isOwner) return toast("Hanya owner.");
    const u = admUid.value.trim(); if (!u) return;
    await remove(ref(db, "admins/"+u));
    toast("Revoked.");
  };

  // Auth
  btnLogin.onclick = async () => {
    try {
      await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
    } catch (e) {
      console.error(e);
      toast("Login gagal: " + (e.code || e.message));
    }
  };
  [btnLogout, btnLogout2].forEach(b => b.onclick = () => signOut(auth));

  onAuthStateChanged(auth, async (user) => {
    currentUid = user? user.uid : null;
    isOwner = user? user.uid === OWNER_UID : false;
    isAdmin = user? await checkAdmin(user.uid) : false;

    setAuthUI(currentUid, isAdmin, isOwner);
    PAGE.anchor = null;
    await loadPage({ reset: true });
  });

  // First paint (read-only list before login also works)
  await loadPage({ reset: true });

  // UX: submit search with Enter
  qExact.addEventListener('keydown', e=>{ if(e.key==='Enter') btnSearch.click(); });
  qPrefix.addEventListener('keydown', e=>{ if(e.key==='Enter') btnSearch.click(); });
</script>
</body>
</html>
