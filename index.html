<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GxMods Admin Panel</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0f1115;color:#e8e8e8;margin:0}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#161a22;border:1px solid #222633;border-radius:14px;padding:18px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center;margin:8px 0}
    .row > label{min-width:120px;color:#9aa4b2}
    input[type=text],input[type=password],textarea{
      flex:1;background:#0f1320;border:1px solid #232a3a;border-radius:10px;color:#e8e8e8;padding:10px 12px;outline:none
    }
    textarea{min-height:64px}
    button{background:#1e88ff;border:1px solid #166ad9;border-radius:28px;color:#fff;padding:10px 16px;cursor:pointer}
    button.alt{background:transparent;border-color:#395074;color:#a9c7ff}
    button.warn{background:#ef5350;border-color:#e53935}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#9aa4b2}
    .hide{display:none}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#233049;border:1px solid #2f3e5a;font-size:12px}
    .sp{height:10px}
    .hr{height:1px;background:#283246;margin:12px 0}
    .right{margin-left:auto}
  </style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h2>Login Admin</h2>
    <div class="row"><label>Email</label>   <input id="email" type="text" placeholder="admin@example.com"/></div>
    <div class="row"><label>Password</label><input id="pass"  type="password" placeholder="••••••••"/></div>
    <div class="row">
      <button id="btnLogin">Login</button>
      <span id="loginMsg" class="muted"></span>
    </div>
  </div>

  <div class="sp"></div>

  <!-- PANEL -->
  <div id="panelCard" class="card hide">
    <div class="row">
      <div class="pill" id="meUid">UID: -</div>
      <div class="pill" id="isAdmin">Admin: -</div>
      <button id="btnLogout" class="alt right">Logout</button>
    </div>

    <div class="hr"></div>

    <h3>Cari User (Android ID)</h3>
    <div class="row">
      <input id="androidId" type="text" placeholder="mis. a1b2c3d4e5f6abcd" />
      <button id="btnLoad" class="alt">Load</button>
    </div>

    <div id="userCard" class="hide">
      <div class="grid">
        <div class="row"><label>Android ID</label> <input id="f_id" type="text" disabled /></div>
        <div class="row"><label>Key</label>        <input id="f_key" type="text" placeholder="ZXCV-9999-PAID" /></div>
        <div class="row"><label>Premium</label>    <input id="f_premium" type="text" placeholder="true/false" /></div>
        <div class="row"><label>Role</label>       <input id="f_role" type="text" placeholder="user/admin" /></div>
        <div class="row"><label>Banned</label>     <input id="f_banned" type="text" placeholder="true/false" /></div>
        <div class="row"><label>Until</label>      <input id="f_until" type="text" placeholder="dd-MM-yyyy atau epoch/ms" /></div>
      </div>
      <div class="row"><label>Reason</label><textarea id="f_reason" placeholder="alasan ban (opsional)"></textarea></div>
      <div class="row">
        <button id="btnRotate" class="alt">Rotate Key</button>
        <button id="btnBan" class="warn">Ban</button>
        <button id="btnUnban" class="alt">Unban</button>
        <button id="btnSave">Save</button>
        <span id="saveMsg" class="muted right"></span>
      </div>
    </div>

    <div id="emptyMsg" class="muted">Belum ada data user yang dimuat.</div>
  </div>
</div>

<!-- Firebase v9+ ES Modules (CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

  // === Config kamu ===
  const firebaseConfig = {
    apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
    authDomain: "animeplay-738a4.firebaseapp.com",
    databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
    projectId: "animeplay-738a4",
    storageBucket: "animeplay-738a4.firebasestorage.app",
    messagingSenderId: "129738568083",
    appId: "1:129738568083:web:d144ad8d1a66d893213866",
    measurementId: "G-J6G96TPMHX"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  try { isSupported().then(ok => { if (ok) getAnalytics(app); }); } catch(_) {}

  const auth = getAuth(app);
  const db   = getDatabase(app);

  // DOM helpers
  const $ = (id)=>document.getElementById(id);
  const loginCard=$("loginCard"), panelCard=$("panelCard");
  const meUid=$("meUid"), isAdmin=$("isAdmin");
  const btnLogin=$("btnLogin"), loginMsg=$("loginMsg"), btnLogout=$("btnLogout");
  const btnLoad=$("btnLoad"), androidId=$("androidId");
  const userCard=$("userCard"), emptyMsg=$("emptyMsg"), saveMsg=$("saveMsg");
  const f = {
    id:$("f_id"), key:$("f_key"), premium:$("f_premium"), role:$("f_role"),
    banned:$("f_banned"), until:$("f_until"), reason:$("f_reason")
  };
  const btnRotate=$("btnRotate"), btnBan=$("btnBan"), btnUnban=$("btnUnban"), btnSave=$("btnSave");

  let ADMIN_OK = false;

  const setBusy = (el,on)=>{ el.disabled=!!on; };
  const toast = (msg)=>{ saveMsg.textContent=msg; setTimeout(()=>saveMsg.textContent="", 2500); };
  const asBool = (v)=> typeof v==="boolean" ? v : ["1","true","yes","y"].includes(String(v||"").trim().toLowerCase());
  const randKey = ()=> {
    const alphabet="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s=""; for(let i=0;i<4;i++){ s+=alphabet[Math.floor(Math.random()*alphabet.length)]; }
    return s+"-"+Date.now().toString(36).toUpperCase();
  };

  async function checkIsAdmin(uid){
    try{
      const snap = await get(ref(db, "admins/"+uid));
      return !!snap.val();
    }catch(e){
      // Kalau rules blokir read, anggap bukan admin
      return false;
    }
  }

  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      loginCard.classList.remove("hide");
      panelCard.classList.add("hide");
      return;
    }
    meUid.textContent = "UID: " + u.uid;
    ADMIN_OK = await checkIsAdmin(u.uid);
    isAdmin.textContent = "Admin: " + (ADMIN_OK ? "true" : "false");
    loginCard.classList.add("hide");
    panelCard.classList.remove("hide");
    if(!ADMIN_OK){ alert("Akun ini belum terdaftar sebagai admin.\nSet /admins/"+u.uid+" = true di Realtime Database."); }
  });

  btnLogin.onclick = async ()=>{
    setBusy(btnLogin,true); loginMsg.textContent="";
    const email = $("email").value.trim(), pass = $("pass").value;
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(e){ loginMsg.textContent = e.message || "Login gagal"; }
    finally{ setBusy(btnLogin,false); }
  };
  btnLogout.onclick = ()=>signOut(auth);

  // Load user by Android ID
  btnLoad.onclick = async ()=>{
    const id = androidId.value.trim();
    if(!id){ toast("Isi Android ID dulu"); return; }
    setBusy(btnLoad,true); emptyMsg.classList.add("hide"); userCard.classList.add("hide");
    try{
      const snap = await get(ref(db, "users/"+id));
      if(!snap.exists()){ emptyMsg.textContent="User tidak ditemukan."; emptyMsg.classList.remove("hide"); return; }
      const v = snap.val();
      f.id.value = id;
      f.key.value = v.key || "";
      f.premium.value = String(!!v.premium);
      f.role.value = v.role || "user";
      f.banned.value = String(!!v.banned);
      f.until.value = v.until || "";
      f.reason.value = v.reason || "";
      userCard.classList.remove("hide");
    }catch(e){
      emptyMsg.textContent = "Gagal load: "+(e.message||e); emptyMsg.classList.remove("hide");
    }finally{ setBusy(btnLoad,false); }
  };

  // Actions
  btnRotate.onclick = ()=>{ f.key.value = randKey(); toast("Key di-rotate (belum disave)."); };
  btnBan.onclick    = ()=>{ f.banned.value = "true"; if(!f.reason.value) f.reason.value = "Violation"; toast("Set banned = true (belum disave)."); };
  btnUnban.onclick  = ()=>{ f.banned.value = "false"; f.reason.value = ""; f.until.value = ""; toast("Set banned = false (belum disave)."); };

  btnSave.onclick = async ()=>{
    if(!ADMIN_OK){ alert("Bukan admin."); return; }
    const id = f.id.value.trim(); if(!id){ toast("Tidak ada ID."); return; }
    const payload = {
      key: f.key.value.trim(),
      premium: asBool(f.premium.value),
      role: (f.role.value.trim()||"user"),
      banned: asBool(f.banned.value),
      until: f.until.value.trim(),
      reason: f.reason.value.trim(),
      updatedAt: Date.now()
    };
    setBusy(btnSave,true);
    try{
      await update(ref(db, "users/"+id), payload);
      toast("Saved.");
    }catch(e){
      toast("Gagal save: "+(e.message||e));
    }finally{ setBusy(btnSave,false); }
  };
</script>
</body>
</html>
