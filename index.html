
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>GxMods Admin Panel</title>
  <style>
    :root{
      --bg:#0f141a;
      --card:#151b23;
      --muted:#8aa0b2;
      --text:#e8eef5;
      --primary:#23c55e;
      --primary-700:#16a34a;
      --danger:#ef5350;
      --danger-700:#d32f2f;
      --stroke:#243042;
      --chip:#1c2430;
      --chipStroke:#2a3647;
      --input:#10161c;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at right -200px top -200px, rgba(35,197,94,.07), transparent 60%),
                  radial-gradient(900px 500px at left -200px bottom -200px, rgba(59,130,246,.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px 80px}
    .topbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;
      background:color-mix(in srgb, var(--card) 94%, white 6%);
      border:1px solid var(--stroke); padding:10px; border-radius:20px; box-shadow:var(--shadow);
      position:sticky; top:8px; z-index:10; backdrop-filter: blur(6px);
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:8px 12px; border-radius:999px; border:1px solid var(--chipStroke); background:var(--chip); color:var(--text); font-size:13px}
    .btn{appearance:none; border:1px solid var(--stroke); background:var(--card); color:var(--text);
      padding:10px 16px; border-radius:999px; cursor:pointer; transition:.15s all ease; font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--primary); border-color:var(--primary-700); color:#07170d}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.danger{background:var(--danger); border-color:var(--danger-700); color:#180b0b}
    .btn.ghost{background:transparent}
    .btn.slim{padding:8px 12px;border-radius:12px; font-size:14px}
    .card{
      background:color-mix(in srgb, var(--card) 94%, white 6%);
      border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
      margin-top:14px;
    }
    h2{margin:0 0 14px 0; font-size:20px; letter-spacing:.2px}
    .grid{
      display:grid; grid-template-columns: 1fr 1fr; gap:16px;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px 8px}
    input,select,textarea{
      width:100%; padding:12px 12px; background:var(--input); border:1px solid var(--stroke);
      border-radius:12px; color:var(--text); outline:none; transition:.15s border ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.02);
    }
    input::placeholder,textarea::placeholder{color:#617287}
    textarea{min-height:70px; resize:vertical}
    .row{display:grid; grid-template-columns: 180px 1fr; gap:10px; align-items:center}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted); margin-top:10px}
    .table{width:100%; display:grid; gap:8px; margin-top:10px}
    .thead,.tr{
      display:grid; grid-template-columns: 1.2fr 1fr 0.7fr 0.9fr 0.7fr; gap:8px; align-items:center;
      border:1px solid var(--stroke); background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      padding:10px; border-radius:12px;
    }
    .thead{background:transparent; border-color:transparent; font-weight:700; color:#a7bacb; padding:0 6px}
    .td input, .td select{height:40px}
    .tr{background:var(--card)}
    .td.center{display:flex;justify-content:center}
    .td.right{display:flex;justify-content:flex-end}
    .row-actions{display:flex; gap:8px; justify-content:flex-end}
    .muted{color:var(--muted)}
    .toolbar{display:grid; grid-template-columns:1fr 280px 120px; gap:10px; align-items:end}
    @media (max-width:820px){ .toolbar{grid-template-columns:1fr 1fr} .toolbar .only-desktop{display:none} }
    @media (max-width:640px){
      .thead{display:none}
      .tr{grid-template-columns: 1fr; gap:6px; padding:12px}
      .td[data-label]::before{content:attr(data-label); display:block; font-size:11px; color:var(--muted); margin-bottom:4px}
      .row-actions{justify-content:stretch}
    }
    .toast{position:fixed; right:12px; bottom:12px; background:#0b1117; border:1px solid var(--stroke); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); display:none}
    .footerSpace{height:120px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#101821; border:1px solid var(--stroke); font-size:12px}
    .badge.dot::before{content:""; width:8px; height:8px; border-radius:99px; background:var(--primary)}
    .badge.red::before{background:var(--danger)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="chips" id="chips">
        <span class="chip">UID: <b id="uidLabel">…</b></span>
        <span class="chip">Admin: <b id="isAdmin">false</b></span>
        <span class="chip">Owner: <b id="isOwner">false</b></span>
      </div>
      <div class="actions">
        <button id="logoutBtn" class="btn slim">Logout</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h2>Buat / Ubah User</h2>
        <div class="row">
          <label>Android ID</label>
          <input id="f_id" placeholder="contoh: a1b2c3d4e5f6abcd" autocomplete="off">
        </div>
        <div class="row">
          <label>Key</label>
          <input id="f_key" placeholder="contoh: ZXCV-5R3K-PAID" autocomplete="off">
        </div>
        <div class="row">
          <label>Alasan (opsional)</label>
          <input id="f_reason" placeholder="Misal: Abuse">
        </div>
        <div class="row">
          <label>Sampai (opsional, 25-12-2025 / 1735171200000)</label>
          <input id="f_until" placeholder="dd-mm-yyyy ATAU epoch(ms)">
        </div>
        <div class="row">
          <label>Banned</label>
          <select id="f_banned">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="actions" style="margin-top:14px">
          <button id="saveBtn" class="btn primary" style="flex:1">Simpan</button>
          <button id="deleteBtn" class="btn danger" style="flex:1">Hapus</button>
        </div>
        <div class="hint">Kolom “Android ID” & “Key” wajib. Tanpa tombol copy & tanpa generate sesuai permintaan.</div>
      </section>

      <section class="card">
        <h2>Users List</h2>
        <div class="toolbar">
          <div>
            <label>Pencarian (Android ID penuh)</label>
            <input id="searchExact" placeholder="tempel Android ID untuk cari 1 user">
          </div>
          <div>
            <label>Search Prefix</label>
            <input id="searchPrefix" placeholder="misal: a1b2">
          </div>
          <div class="only-desktop">
            <label>&nbsp;</label>
            <button id="doSearch" class="btn slim" style="width:100%">Search</button>
          </div>
        </div>

        <div class="thead" style="margin-top:10px">
          <div>Android ID</div><div>Key</div><div>Banned</div><div>Until</div><div class="right">Aksi</div>
        </div>
        <div id="rows" class="table"></div>

        <div class="actions" style="margin-top:12px">
          <button id="loadMore" class="btn slim" style="width:100%">Muat lebih</button>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>Kelola Admin (Owner saja)</h2>
      <div class="row">
        <label>UID</label>
        <input id="adminUid" placeholder="tempel UID untuk grant / revoke">
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="grantBtn" class="btn primary" style="flex:1">Grant Admin</button>
        <button id="revokeBtn" class="btn danger" style="flex:1">Revoke Admin</button>
      </div>
      <div class="hint">Owner saat ini: <b id="ownerId">-</b></div>
    </section>

    <div class="footerSpace"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== Firebase (CDN Modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, child, get, set, update, remove, query, orderByKey, startAt, endAt, limitToFirst } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // ---- CONFIG (SESUIKAN punyamu)
    const firebaseConfig = {
      apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
      authDomain: "animeplay-738a4.firebaseapp.com",
      databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
      projectId: "animeplay-738a4",
      storageBucket: "animeplay-738a4.firebasestorage.app",
      messagingSenderId: "129738568083",
      appId: "1:129738568083:web:d144ad8d1a66d893213866",
      measurementId: "G-J6G96TPMHX"
    };
    const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";
    const PAGE = 25;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== Helpers UI =====
    const $ = (s, p=document)=>p.querySelector(s);
    const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));
    const toast = (msg)=>{ const el=$("#toast"); el.textContent=msg; el.style.display="block"; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display="none", 2200); };
    const fmt = (v)=> v==null? "" : String(v);

    // ===== State =====
    let myUid = null;
    let isAdmin = false;
    let isOwner = false;
    let mode = "default";  // 'default' | 'prefix' | 'exact'
    let cursor = null;     // last key for pagination
    let lastBatchKeys = []; // for skipping duplicate when startAt

    // ===== Auth =====
    const ensureAnon = async ()=>{
      try{ await signInAnonymously(auth); }
      catch(e){ console.error(e); toast("Anon login gagal"); }
    };
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ await ensureAnon(); return; }
      myUid = user.uid;
      $("#uidLabel").textContent = myUid;
      isOwner = myUid === OWNER_UID;
      $("#isOwner").textContent = isOwner ? "true" : "false";
      $("#ownerId").textContent = OWNER_UID;

      // cek admin flag di DB
      try{
        const snap = await get(ref(db, "admins/"+myUid));
        isAdmin = snap.exists() && snap.val() === true;
        $("#isAdmin").textContent = isAdmin ? "true" : "false";
        if(!isAdmin){
          toast("Akun ini belum admin. Tambahkan /admins/"+myUid+" = true");
        } else {
          resetListState();
          await loadInitial();
        }
      }catch(e){ console.error(e); toast("Gagal cek admin"); }
    });

    $("#logoutBtn").onclick = async ()=>{
      try{ await signOut(auth); }catch(e){}
      location.reload();
    };

    // ===== CRUD =====
    $("#saveBtn").onclick = async ()=>{
      if(!isAdmin) return toast("Bukan admin.");
      const id = $("#f_id").value.trim();
      const key = $("#f_key").value.trim();
      if(!id || !key){ toast("Android ID & Key wajib."); return; }
      const data = {
        key,
        banned: $("#f_banned").value === "true",
        reason: $("#f_reason").value.trim() || "",
        until: $("#f_until").value.trim() || "",
        updatedAt: Date.now()
      };
      try{
        await set(ref(db, "users/"+id), data);
        toast("Tersimpan.");
        // optional: refresh the row if visible
      }catch(e){ console.error(e); toast("Gagal menyimpan."); }
    };

    $("#deleteBtn").onclick = async ()=>{
      if(!isAdmin) return toast("Bukan admin.");
      const id = $("#f_id").value.trim();
      if(!id){ toast("Isi Android ID lebih dulu."); return; }
      if(!confirm("Hapus user "+id+" ?")) return;
      try{ await remove(ref(db, "users/"+id)); toast("Terhapus."); }
      catch(e){ console.error(e); toast("Gagal menghapus."); }
    };

    // ===== List & Search =====
    $("#doSearch").onclick = ()=>{ doSearch(); };
    $("#searchPrefix").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doSearch(); });
    $("#searchExact").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doSearch(); });

    const doSearch = async ()=>{
      if(!isAdmin) return;
      const exact = $("#searchExact").value.trim();
      const prefix = $("#searchPrefix").value.trim();
      resetListState();

      if(exact){
        mode = "exact";
        const snap = await get(ref(db, "users/"+exact));
        $("#rows").innerHTML = "";
        if(snap.exists()){
          renderRow(exact, snap.val());
        } else {
          $("#rows").innerHTML = `<div class="muted" style="padding:8px 4px">Tidak ditemukan.</div>`;
        }
        return;
      }
      if(prefix){
        mode = "prefix";
        await loadPrefix(prefix);
      }else{
        mode = "default";
        await loadInitial();
      }
    };

    const resetListState = ()=>{
      $("#rows").innerHTML = "";
      cursor = null;
      lastBatchKeys = [];
    };

    const loadInitial = async ()=>{
      // no startAt to avoid invalid bound issues
      try{
        const q = query(ref(db,"users"), orderByKey(), limitToFirst(PAGE));
        const s = await get(q);
        const obj = s.exists() ? s.val() : null;
        renderBatch(obj, true);
      }catch(e){ console.error(e); toast("Gagal memuat data awal."); }
    };

    const loadMore = async ()=>{
      if(mode === "default"){
        if(!cursor) return;
        try{
          const q = query(ref(db,"users"), orderByKey(), startAt(cursor), limitToFirst(PAGE+1));
          const s = await get(q);
          const obj = s.exists() ? s.val() : null;
          renderBatch(obj, false, true);
        }catch(e){ console.error(e); toast("Gagal memuat halaman berikut."); }
      } else if(mode === "prefix"){
        const prefix = $("#searchPrefix").value.trim();
        if(!prefix) return;
        await loadPrefix(prefix, true);
      }
    };
    $("#loadMore").onclick = ()=> loadMore();

    const loadPrefix = async (prefix, next=false)=>{
      try{
        let q;
        if(!next || !cursor){
          q = query(ref(db,"users"), orderByKey(), startAt(prefix), endAt(prefix + "\uf8ff"), limitToFirst(PAGE));
        } else {
          q = query(ref(db,"users"), orderByKey(), startAt(cursor), endAt(prefix + "\uf8ff"), limitToFirst(PAGE+1));
        }
        const s = await get(q);
        const obj = s.exists() ? s.val() : null;
        renderBatch(obj, !next, true);
      }catch(e){ console.error(e); toast("Gagal memuat data."); }
    };

    const renderBatch = (obj, replace=false, skipDup=false)=>{
      const container = $("#rows");
      if(replace) container.innerHTML = "";
      if(!obj || Object.keys(obj).length===0){
        if(replace) container.innerHTML = `<div class="muted" style="padding:8px 4px">Belum ada data user yang dimuat.</div>`;
        return;
      }
      let keys = Object.keys(obj);
      keys.sort(); // orderByKey returns ordered but make sure
      if(skipDup && cursor && keys[0]===cursor){ keys = keys.slice(1); }
      if(keys.length===0) return;

      keys.forEach(k=> renderRow(k, obj[k]));
      cursor = keys[keys.length-1];
    };

    const renderRow = (id, data)=>{
      const row = document.createElement("div");
      row.className = "tr";
      row.innerHTML = `
        <div class="td" data-label="Android ID"><div class="badge">${escapeHtml(id)}</div></div>
        <div class="td" data-label="Key"><input value="${escapeHtml(fmt(data?.key||""))}" /></div>
        <div class="td" data-label="Banned">
          <select>
            <option value="false" ${data?.banned===false?"selected":""}>false</option>
            <option value="true" ${data?.banned===true?"selected":""}>true</option>
          </select>
        </div>
        <div class="td" data-label="Until"><input value="${escapeHtml(fmt(data?.until||""))}" placeholder="dd-mm-yyyy / epoch" /></div>
        <div class="td right" data-label="Aksi">
          <div class="row-actions">
            <button class="btn slim primary">Save</button>
            <button class="btn slim danger">Del</button>
          </div>
        </div>
      `;
      const [keyEl, banSel, untilEl] = [
        $("input", row),
        $("select", row),
        $$("input", row)[1]
      ];
      const [saveBtn, delBtn] = $$(".btn", row);

      saveBtn.onclick = async ()=>{
        if(!isAdmin) return toast("Bukan admin.");
        const payload = {
          key: keyEl.value.trim(),
          banned: banSel.value==="true",
          until: untilEl.value.trim(),
          reason: "", // tidak diedit di list, pakai form atas kalau perlu
          updatedAt: Date.now()
        };
        try{ await update(ref(db,"users/"+id), payload); toast("Tersimpan."); }
        catch(e){ console.error(e); toast("Gagal menyimpan."); }
      };
      delBtn.onclick = async ()=>{
        if(!isAdmin) return toast("Bukan admin.");
        if(!confirm("Hapus user "+id+" ?")) return;
        try{ await remove(ref(db,"users/"+id)); row.remove(); toast("Terhapus."); }
        catch(e){ console.error(e); toast("Gagal menghapus."); }
      };
      $("#rows").appendChild(row);
    };

    // ===== Admin Manage =====
    const canOwner = ()=>{
      if(!isOwner){ toast("Hanya owner."); return false; }
      return true;
    };
    $("#grantBtn").onclick = async ()=>{
      if(!canOwner()) return;
      const id = $("#adminUid").value.trim();
      if(!id) return;
      try{ await set(ref(db,"admins/"+id), true); toast("Granted."); }
      catch(e){ console.error(e); toast("Gagal grant."); }
    };
    $("#revokeBtn").onclick = async ()=>{
      if(!canOwner()) return;
      const id = $("#adminUid").value.trim();
      if(!id) return;
      try{ await remove(ref(db,"admins/"+id)); toast("Revoked."); }
      catch(e){ console.error(e); toast("Gagal revoke."); }
    };

    // Utils
    function escapeHtml(s){
      return s.replace(/[&<>"'`=\/]/g, function (c) {
        return {
          "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"
        }[c];
      });
    }

    // Kick off
    ensureAnon();
  </script>
</body>
</html>
