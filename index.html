<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GxMods Admin Panel</title>
<style>
  :root{
    --bg:#0f141a;
    --card:#161c23;
    --muted:#11161c;
    --text:#e6eef8;
    --sub:#9fb3c8;
    --brand:#6aa3ff;
    --ok:#2ecc71;
    --danger:#ff6b6b;
    --stroke:#243140;
    --chip:#1d2631;
    --input:#0c1218;
    --shadow:0 0 0 1px rgba(0,0,0,.05),0 10px 24px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
    -webkit-text-size-adjust:100%;
    text-size-adjust:100%;
    touch-action:manipulation;
  }
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px;}
  .row{display:grid;gap:18px;}
  @media (min-width: 980px){ .row{ grid-template-columns: 1fr 1fr; } }
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 12px;font-size:clamp(16px,2.5vw,20px);letter-spacing:.2px}
  .topbar{
    position:sticky;top:0;z-index:10;
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    margin-bottom:14px;
    padding:10px 0 6px;background:linear-gradient(180deg,var(--bg) 70%,transparent);
    backdrop-filter:saturate(1.2);
  }
  .chip{background:var(--chip);border:1px solid var(--stroke);padding:10px 14px;border-radius:999px;color:var(--text);font-size:14px;white-space:nowrap}
  .chip.bad{background:#25181a;border-color:#3a2023;color:#ffb3b3}
  input,select,textarea{
    width:100%;border-radius:12px;border:1px solid var(--stroke);
    padding:13px 12px;background:var(--input);color:var(--text);outline:none;
    min-height:44px;
  }
  input::placeholder,textarea::placeholder{color:#7089a3}
  label{display:block;font-size:13px;color:var(--sub);margin:8px 0 6px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{border:none;border-radius:14px;padding:12px 18px;font-weight:600;color:#0b1117;background:var(--brand);cursor:pointer;min-height:44px}
  .btn.gray{background:#34485f;color:#d2e3f5}
  .btn.ok{background:var(--ok);color:#07140a}
  .btn.danger{background:var(--danger);color:#220a0a}
  .btn.block{width:100%}
  .btn.small{padding:10px 14px;border-radius:12px;min-height:40px}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:8px}
  .th,.td{padding:12px 10px;text-align:left;font-size:14px}
  .tr{background:var(--muted);border:1px solid var(--stroke);border-radius:12px;overflow:hidden;display:grid;grid-template-columns: 1.4fr 1.3fr .9fr 1.2fr .8fr;align-items:center}
  .th{color:#9fb3c8}
  .empty{padding:12px;color:#9fb3c8}
  .footer-actions{display:flex;justify-content:center;margin-top:10px}
  .pill{border-radius:999px;padding:10px 14px;border:1px solid var(--stroke);background:#0c1218;color:var(--text);}
  .hidden{display:none !important}
  .sep{height:10px}
  .logout-spot{display:flex;justify-content:flex-end;margin-bottom:12px}
  .kiri .card{height:100%}
  /* ===== Mobile-first tweaks for small DPI / narrow screens ===== */
  @media (max-width: 560px){
    body{font-size:15px}
    .wrap{padding:0 10px;margin:18px auto}
    .card{border-radius:12px;padding:12px;box-shadow:0 0 0 1px rgba(0,0,0,.05),0 6px 16px rgba(0,0,0,.22)}
    .chip{padding:8px 10px;font-size:12px}
    .row2{grid-template-columns:1fr;gap:10px}
    .topbar .actions{width:100%}
    .topbar .actions input{min-width:0;flex:1 1 120px}
    .topbar .actions #btnLogin{flex:0 0 120px}
    .th{display:none} /* hide header row */
    .tr{grid-template-columns:1fr;border-radius:10px}
    .td{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid rgba(255,255,255,.03)}
    .td:first-child{border-top:none}
    .td::before{content:attr(data-label);color:var(--sub);font-size:12px;margin-right:8px;flex:0 0 44%}
    .td input,.td select{flex:1 1 auto;min-width:0}
    .actions{gap:8px}
    .btn.small{padding:9px 12px}
    .pill{width:100%;text-align:center}
  }
  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{scroll-behavior:auto;transition:none !important;animation:none !important}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar" id="topBadges">
      <span class="chip" id="uidChip">UID: -</span>
      <span class="chip" id="adminChip">Admin:false</span>
      <span class="chip" id="ownerChip">Owner:false</span>
      <span class="chip bad hidden" id="warnDomain">Tambahkan domain Pages ke Auth → Authorized domains.</span>
      <div style="flex:1"></div>
      <div class="actions" id="loginRow">
        <input id="email" type="email" placeholder="email admin" autocomplete="username" autocapitalize="none" spellcheck="false" style="min-width:240px">
        <input id="password" type="password" placeholder="password" autocomplete="current-password" style="min-width:180px">
        <button class="btn small" id="btnLogin">Login</button>
      </div>
      <button class="btn gray small hidden" id="btnLogout">Logout</button>
    </div>

    <div class="row">
      <div class="kiri">
        <div class="card">
          <h2>Buat / Ubah User</h2>
          <label>Android ID</label>
          <input id="formId" placeholder="contoh: a1b2c3d4e5f6abcd" autocapitalize="none" autocorrect="off" spellcheck="false" />
          <label>Key</label>
          <input id="formKey" placeholder="contoh: ZXCV-5R3K-PAID" autocapitalize="characters" />
          <label>Alasan (opsional)</label>
          <input id="formReason" placeholder="Misal: Abuse" />
          <div class="row2">
            <div>
              <label>Sampai (opsional, 25-12-2025 / 1735171200000)</label>
              <input id="formUntil" inputmode="numeric" placeholder="dd-mm-yyyy ATAU epoch(ms)" />
            </div>
            <div>
              <label>Banned</label>
              <select id="formBanned">
                <option>false</option>
                <option>true</option>
              </select>
            </div>
          </div>
          <div class="sep"></div>
          <div class="actions">
            <button class="btn ok block" id="btnSave">Simpan</button>
            <button class="btn danger block" id="btnDelete">Hapus</button>
          </div>
          <p style="color:#8aa3bd;margin:10px 2px 0">Kolom “Android ID” & “Key” wajib. Tanpa tombol copy & tanpa generate sesuai permintaan.</p>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="logout-spot"><button class="btn gray small hidden" id="btnLogout2">Logout</button></div>
          <h2>Users List</h2>
          <label>Pencarian (Android ID penuh)</label>
          <input id="searchExact" placeholder="tempel Android ID untuk cari 1 user" autocapitalize="none" autocorrect="off" spellcheck="false" />
          <div class="row2" style="margin-top:10px">
            <div>
              <label>Search Prefix</label>
              <input id="searchPrefix" placeholder="misal: a1b2" autocapitalize="none" autocorrect="off" spellcheck="false">
            </div>
            <div style="align-self:end">
              <button class="btn block" id="btnSearch">Search</button>
            </div>
          </div>

          <div class="sep"></div>
          <!-- Header row hidden on mobile via CSS -->
          <div class="tr th" style="grid-template-columns:1.4fr 1.3fr .9fr 1.2fr .8fr">
            <div class="th">Android ID</div>
            <div class="th">Key</div>
            <div class="th">Banned</div>
            <div class="th">Until</div>
            <div class="th">Aksi</div>
          </div>
          <div id="listArea"></div>
          <div class="footer-actions">
            <button id="btnMore" class="pill hidden">Muat lebih</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>Kelola Admin (Owner saja)</h2>
          <label>UID</label>
          <input id="adminUid" placeholder="tempel UID untuk grant / revoke" autocapitalize="none" autocorrect="off" spellcheck="false">
          <div class="actions" style="margin-top:10px">
            <button class="btn ok" id="btnGrant">Grant Admin</button>
            <button class="btn danger" id="btnRevoke">Revoke Admin</button>
          </div>
          <p style="color:#8aa3bd;margin:10px 2px 0">Owner: <span id="ownerId"></span></p>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, get, set, update, remove, query, orderByKey, limitToFirst, startAt, endAt } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // ==== CONFIG (punya kamu) ====
  const firebaseConfig = {
    apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
    authDomain: "animeplay-738a4.firebaseapp.com",
    databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
    projectId: "animeplay-738a4",
    storageBucket: "animeplay-738a4.firebasestorage.app",
    messagingSenderId: "129738568083",
    appId: "1:129738568083:web:d144ad8d1a66d893213866",
    measurementId: "G-J6G96TPMHX",
  };
  const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";
  document.getElementById("ownerId").textContent = OWNER_UID;

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // ====== UI helpers ======
  const el = (id) => document.getElementById(id);
  const $list = el("listArea");
  const $btnMore = el("btnMore");
  const $loginRow = el("loginRow");
  const $btnLogout = el("btnLogout");
  const $btnLogout2 = el("btnLogout2");
  const $uidChip = el("uidChip");
  const $adminChip = el("adminChip");
  const $ownerChip = el("ownerChip");

  let isAdmin = false;
  let isOwner = false;
  let cursor = null;
  let PAGE = window.matchMedia("(max-width: 560px)").matches ? 12 : 25; // lebih ringan di HP kecil
  let lastPrefix = "";
  let exactMode = null; // if set, we show single user result

  function setLoadingList(msg){
    $list.innerHTML = '<div class="empty">'+(msg||"Memuat...")+'</div>';
    $btnMore.classList.add("hidden");
  }
  function fmt(v){ return (v==null?"":String(v)); }
  function getFormDataFromRow(row){
    return {
      key: row.querySelector(".inpKey").value.trim(),
      banned: row.querySelector(".inpBan").value === "true",
      until: row.querySelector(".inpUntil").value.trim(),
      reason: row.querySelector(".inpReason")?.value.trim() || "",
    };
  }
  function setTopBadges(user, admin){
    $uidChip.textContent = "UID: "+(user?user.uid:"-");
    $adminChip.textContent = "Admin:"+(admin?"true":"false");
    isOwner = !!user && user.uid === OWNER_UID;
    $ownerChip.textContent = "Owner:"+(isOwner?"true":"false");
    if(user){
      $loginRow.classList.add("hidden");
      $btnLogout.classList.remove("hidden");
      $btnLogout2.classList.remove("hidden");
    } else {
      $loginRow.classList.remove("hidden");
      $btnLogout.classList.add("hidden");
      $btnLogout2.classList.add("hidden");
    }
    // disable admin-only controls
    const controls = document.querySelectorAll(".needAdmin");
    controls.forEach(c => c.disabled = !admin);
  }
  function rowNode(aid, data){
    const banned = data?.banned===true ? "true" : "false";
    const until = fmt(data?.until);
    const key = (typeof data === "string") ? data : fmt(data?.key);
    const reason = (typeof data === "string") ? "" : fmt(data?.reason);
    const tr = document.createElement("div");
    tr.className = "tr";
    tr.innerHTML = `
      <div class="td" data-label="Android ID" style="padding-left:14px;font-weight:600;word-break:break-all">${aid}</div>
      <div class="td" data-label="Key"><input class="inpKey needAdmin" value="${key||""}" placeholder="key" /></div>
      <div class="td" data-label="Banned">
        <select class="inpBan needAdmin">
          <option ${banned==="false"?"selected":""}>false</option>
          <option ${banned==="true"?"selected":""}>true</option>
        </select>
      </div>
      <div class="td" data-label="Until"><input class="inpUntil needAdmin" value="${until||""}" placeholder="dd-mm-yyyy / epoch" inputmode="numeric"/></div>
      <div class="td" data-label="Aksi">
        <div class="actions">
          <button class="btn ok small needAdmin">Save</button>
          <button class="btn danger small needAdmin">Del</button>
        </div>
        <input class="inpReason needAdmin hidden" value="${reason}" />
      </div>
    `;
    // Hooks
    const btnSave = tr.querySelector(".btn.ok");
    const btnDel  = tr.querySelector(".btn.danger");
    btnSave.onclick = async () => {
      if(!isAdmin){ alert("Hanya admin."); return; }
      const payload = getFormDataFromRow(tr);
      if(!payload.key){ alert("Key wajib."); return; }
      payload.updatedAt = Date.now();
      await update(ref(db, "users/"+aid), payload);
      btnSave.textContent = "Saved"; setTimeout(()=>btnSave.textContent="Save", 1200);
    };
    btnDel.onclick = async () => {
      if(!isAdmin){ alert("Hanya admin."); return; }
      if(!confirm("Hapus user "+aid+" ?")) return;
      await remove(ref(db,"users/"+aid));
      tr.remove();
    };
    return tr;
  }

  // ====== Data loading ======
  async function loadFirst(){
    exactMode = null;
    lastPrefix = "";
    cursor = null;
    setLoadingList();
    await loadPage();
  }

  async function loadPage(){
    try{
      const base = ref(db,"users");
      let q;
      if(exactMode){ // exact android id
        const snap = await get(ref(db,"users/"+exactMode));
        $list.innerHTML = "";
        if(!snap.exists()){ $list.innerHTML = '<div class="empty">Tidak ditemukan.</div>'; return; }
        $list.appendChild(rowNode(exactMode, snap.val()));
        $btnMore.classList.add("hidden");
        return;
      }
      if(lastPrefix){ // prefix mode
        if(cursor){
          q = query(base, orderByKey(), startAt(cursor), endAt(lastPrefix + "\\uf8ff"), limitToFirst(PAGE+1));
        } else {
          q = query(base, orderByKey(), startAt(lastPrefix), endAt(lastPrefix + "\\uf8ff"), limitToFirst(PAGE+1));
        }
      } else { // default listing
        if(cursor){
          q = query(base, orderByKey(), startAt(cursor), limitToFirst(PAGE+1));
        } else {
          q = query(base, orderByKey(), limitToFirst(PAGE+1));
        }
      }
      const snap = await get(q);
      const val = snap.val() || {};
      const keys = Object.keys(val);
      if(cursor && keys.length && keys[0]===cursor){ keys.shift(); } // buang duplikat
      // Render
      if(!cursor){ $list.innerHTML = ""; }
      if(keys.length===0 && !cursor){
        $list.innerHTML = '<div class="empty">Belum ada data user yang dimuat.</div>';
        $btnMore.classList.add("hidden");
        return;
      }
      keys.slice(0,PAGE).forEach(k => {
        $list.appendChild(rowNode(k, val[k]));
      });
      if(keys.length > PAGE){
        cursor = keys[PAGE-1+1]; // element terakhir yang tampil berikutnya dipakai sebagai startAt di panggilan selanjutnya
        $btnMore.classList.remove("hidden");
      } else {
        $btnMore.classList.add("hidden");
      }
    }catch(e){
      console.error(e);
      $list.innerHTML = '<div class="empty">Gagal memuat data.</div>';
      $btnMore.classList.add("hidden");
    }
  }

  // ====== Events ======
  $btnMore.onclick = loadPage;
  el("btnSearch").onclick = async () => {
    const exact = el("searchExact").value.trim();
    const pref = el("searchPrefix").value.trim();
    if(exact){
      exactMode = exact;
      setLoadingList();
      await loadPage();
      return;
    }
    lastPrefix = pref;
    cursor = null;
    exactMode = null;
    setLoadingList();
    await loadPage();
  };
  el("btnSave").onclick = async () => {
    if(!isAdmin){ alert("Hanya admin."); return; }
    const id = el("formId").value.trim();
    const key = el("formKey").value.trim();
    if(!id || !key){ alert("Android ID & Key wajib."); return; }
    const payload = {
      key,
      banned: (el("formBanned").value==="true"),
      until: el("formUntil").value.trim(),
      reason: el("formReason").value.trim(),
      updatedAt: Date.now()
    };
    await set(ref(db,"users/"+id), payload);
    alert("Tersimpan.");
    await loadFirst();
  };
  el("btnDelete").onclick = async () => {
    if(!isAdmin){ alert("Hanya admin."); return; }
    const id = el("formId").value.trim();
    if(!id){ alert("Masukkan Android ID untuk hapus."); return; }
    if(!confirm("Hapus user "+id+" ?")) return;
    await remove(ref(db,"users/"+id));
    alert("Terhapus.");
    await loadFirst();
  };

  // Admin management
  el("btnGrant").onclick = async () => {
    if(!isOwner){ alert("Hanya owner."); return; }
    const uid = el("adminUid").value.trim(); if(!uid) return;
    await set(ref(db,"admins/"+uid), true); alert("Granted.");
  };
  el("btnRevoke").onclick = async () => {
    if(!isOwner){ alert("Hanya owner."); return; }
    const uid = el("adminUid").value.trim(); if(!uid) return;
    await remove(ref(db,"admins/"+uid)); alert("Revoked.");
  };

  // Auth
  el("btnLogin").onclick = async () => {
    const email = el("email").value.trim();
    const pass = el("password").value.trim();
    if(!email || !pass){ alert("Isi email & password."); return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      alert("Login gagal: "+(e?.message||e));
      console.error(e);
    }
  };
  async function doLogout(){ try{ await signOut(auth); }catch(e){} }
  $btnLogout.onclick = doLogout;
  $btnLogout2.onclick = doLogout;

  async function refreshAdmin(uid){
    if(!uid){ isAdmin=false; setTopBadges(null,false); return; }
    try{
      const v = await get(ref(db,"admins/"+uid));
      isAdmin = v.exists() && v.val()===true;
    }catch{ isAdmin=false; }
    setTopBadges({uid}, isAdmin);
  }

  onAuthStateChanged(auth, async (user) => {
    await refreshAdmin(user?.uid || null);
    // otomatis load list ketika sudah ada auth (agar read true pun tetap konsisten alur)
    await loadFirst();
  });

  // hint domain untuk popup oauth (prevent noise); email/pw tetap jalan walau domain belum ditambah
  try{
    const host = location.hostname;
    const ok = [ "localhost", "127.0.0.1", "animeplay-738a4.firebaseapp.com" ];
    if(!ok.includes(host)){ /* hanya info visual */ }
  }catch{}
</script>
</body>
</html>
