<!doctype html>
<html lang="id" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>AnimePlay Admin Panel</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root {
      --bg: #0f1115;
      --card: #171a21;
      --muted: #212734;
      --text: #e9eefc;
      --text-dim: #9fb0d0;
      --pri: #4f8cff;
      --pri-700:#3a6fd6;
      --ok: #2eb872;
      --warn: #f8b84e;
      --err: #ef5350;
      --stroke: #2a3344;
      --focus: #7fb0ff;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f6f8ff; --card:#ffffff; --muted:#eef2ff; --text:#0f172a;
        --text-dim:#41506b; --pri:#1e88ff; --pri-700:#166ad9; --stroke:#d9e0ef;
      }
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:var(--pri);text-decoration:none}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1 1 auto}
    .row.right{justify-content:flex-end}
    .title{font-weight:700;font-size:16px}
    .muted{color:var(--text-dim)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--muted);border:1px solid var(--stroke);font-size:12px}
    .ok{background:color-mix(in oklab, var(--ok) 18%, transparent);border-color:color-mix(in oklab, var(--ok) 55%, var(--stroke))}
    .err{background:color-mix(in oklab, var(--err) 18%, transparent);border-color:color-mix(in oklab, var(--err) 55%, var(--stroke))}
    label{font-size:12px;color:var(--text-dim)}
    input,select,button,textarea{
      font:inherit;color:inherit;background:var(--muted);border:1px solid var(--stroke);
      border-radius:10px;padding:10px 12px;outline:none;min-height:42px
    }
    input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px color-mix(in oklab,var(--focus) 25%, transparent)}
    button{background:var(--pri);border-color:var(--pri-700);cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-gray{background:var(--muted);border-color:var(--stroke)}
    .btn-ok{background:var(--ok);border-color:color-mix(in oklab, var(--ok) 70%, #000)}
    .btn-err{background:var(--err);border-color:color-mix(in oklab, var(--err) 70%, #000)}
    .split{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width: 980px){ .split{grid-template-columns:320px 1fr} }
    .section-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--stroke);padding:8px 6px;text-align:left;vertical-align:top}
    .table th{position:sticky;top:0;background:var(--card);z-index:1}
    .t-actions{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:12px;padding:6px 8px;border-radius:8px;background:var(--muted);border:1px solid var(--stroke)}
    .hidden{display:none !important}
    .w-100{width:100%}
    .w-50{width:50%}
    .nowrap{white-space:nowrap}
    .footer-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    /* Mobile-first comfortable hit targets */
    @media (max-width: 640px){
      .row > *{flex-basis:100%}
      .footer-actions > *{flex:1 1 auto}
      .table th:nth-child(4), .table td:nth-child(4){display:none} /* hide UpdatedAt on very small */
      .t-actions button{flex:1 1 48%}
    }
  </style>
</head>
<body>
  <div class="wrap grid">
    <!-- AUTH CARD -->
    <div id="authCard" class="card">
      <div class="section-head">
        <div class="title">Login Admin</div>
        <div class="row right">
          <span class="badge" id="badgeOwner" title="Owner">Owner</span>
          <span class="badge" id="badgeAdmin" title="Admin">Admin</span>
          <span class="badge" id="badgeUid">UID: -</span>
        </div>
      </div>
      <div class="row">
        <div class="w-100">
          <label>Email</label>
          <input id="email" type="email" autocomplete="username" placeholder="you@example.com">
        </div>
        <div class="w-100">
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••">
        </div>
      </div>
      <div class="row right">
        <button id="btnLogin">Login</button>
      </div>
      <p class="muted" style="margin:6px 0 0">Hanya akun yang ada di <code>/admins</code> yang diizinkan.</p>
    </div>

    <!-- PANEL MAIN -->
    <div id="panel" class="grid hidden">
      <div class="split">
        <!-- Create / Edit quick form -->
        <div class="card">
          <div class="section-head"><div class="title">Buat / Ubah User</div></div>
          <div class="row">
            <div class="w-100">
              <label>Android ID</label>
              <input id="f_androidId" placeholder="contoh: a1b2c3d4e5f6abcd">
            </div>
            <div class="w-100">
              <label>Key</label>
              <input id="f_key" placeholder="contoh: ZXCV-5R3K-PAID">
            </div>
            <div class="w-100">
              <label>Alasan (opsional)</label>
              <input id="f_reason" placeholder="Misal: Abuse">
            </div>
            <div class="w-100">
              <label>Sampai (opsional, 25-12-2025 / 1735171200000)</label>
              <input id="f_until" placeholder="dd-mm-yyyy ATAU epoch(ms)">
            </div>
            <div class="row">
              <button id="btnSave" class="btn-ok">Simpan</button>
              <button id="btnDelete" class="btn-err">Hapus</button>
            </div>
          </div>
          <p class="muted" style="margin:6px 0 0">Kolom “Android ID” & “Key” wajib. Tanpa tombol copy & tanpa generate sesuai permintaan.</p>
        </div>

        <!-- Users List -->
        <div class="card">
          <div class="section-head">
            <div class="title">Users List</div>
            <div class="row right">
              <button id="btnLogout" class="btn-gray">Logout</button>
            </div>
          </div>

          <!-- Hanya dua kontrol: pencarian & prefix -->
          <div class="row">
            <div class="w-100">
              <label>Pencarian (Android ID penuh)</label>
              <input id="q_exact" placeholder="tempel Android ID untuk cari 1 user">
            </div>
            <div class="w-100">
              <label>Search Prefix</label>
              <input id="q_prefix" placeholder="misal: a1b2">
            </div>
          </div>
          <div class="row right" style="margin-top:6px">
            <button id="btnRunSearch" class="btn-gray">Search</button>
          </div>

          <div style="margin-top:10px;max-height:60vh;overflow:auto;border-radius:10px;border:1px solid var(--stroke)">
            <table class="table" id="tbl">
              <thead>
                <tr>
                  <th>Android ID</th>
                  <th>Key</th>
                  <th>Banned</th>
                  <th class="nowrap">Updated</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr id="rowEmpty"><td colspan="5" class="muted">Memuat…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="footer-actions" style="margin-top:8px">
            <button id="btnMore" class="btn-gray">Muat lebih</button>
          </div>
        </div>
      </div>

      <!-- Owner only: admins -->
      <div class="card" id="ownerBox">
        <div class="section-head"><div class="title">Kelola Admin (Owner saja)</div></div>
        <div class="row">
          <div class="w-100">
            <label>UID</label>
            <input id="adm_uid" placeholder="tempel UID untuk grant / revoke">
          </div>
        </div>
        <div class="row">
          <button id="btnGrant" class="btn-ok">Grant Admin</button>
          <button id="btnRevoke" class="btn-err">Revoke Admin</button>
        </div>
        <p class="muted" style="margin:6px 0 0">Owner: <code>SjEQCMqzEMb2PQclx8Iidde3reA3</code></p>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase SDK v10 (modules) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getDatabase, ref, child, get, set, update, remove,
      query, orderByKey, orderByChild, startAt, endAt, limitToFirst, equalTo
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // ===== Config kamu =====
    const firebaseConfig = {
      apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
      authDomain: "animeplay-738a4.firebaseapp.com",
      databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
      projectId: "animeplay-738a4",
      storageBucket: "animeplay-738a4.firebasestorage.app",
      messagingSenderId: "129738568083",
      appId: "1:129738568083:web:d144ad8d1a66d893213866",
      measurementId: "G-J6G96TPMHX"
    };
    const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== DOM =====
    const authCard = document.getElementById("authCard");
    const panel = document.getElementById("panel");
    const badgeUid = document.getElementById("badgeUid");
    const badgeAdmin = document.getElementById("badgeAdmin");
    const badgeOwner = document.getElementById("badgeOwner");
    const ownerBox = document.getElementById("ownerBox");

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");

    const f_androidId = document.getElementById("f_androidId");
    const f_key = document.getElementById("f_key");
    const f_reason = document.getElementById("f_reason");
    const f_until = document.getElementById("f_until");
    const btnSave = document.getElementById("btnSave");
    const btnDelete = document.getElementById("btnDelete");

    const q_exact = document.getElementById("q_exact");
    const q_prefix = document.getElementById("q_prefix");
    const btnRunSearch = document.getElementById("btnRunSearch");
    const btnMore = document.getElementById("btnMore");

    const tbody = document.getElementById("tbody");
    const rowEmpty = document.getElementById("rowEmpty");

    const adm_uid = document.getElementById("adm_uid");
    const btnGrant = document.getElementById("btnGrant");
    const btnRevoke = document.getElementById("btnRevoke");

    // ===== State =====
    let state = {
      current: null,
      isAdmin: false,
      isOwner: false,
      lastKey: null,
      busy: false
    };

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function fmtTime(ms){
      if(!ms) return "-";
      try{
        const d = new Date(Number(ms));
        return d.toLocaleString();
      }catch{ return String(ms); }
    }
    function isValidKeyPath(k){
      return !!k && !(/[.#$[\]/]/.test(k));
    }
    function normalizeUser(aid, val){
      if(val == null) return null;
      if(typeof val === "string"){
        return { androidId: aid, key: val, banned: false, reason: "", until: "", updatedAt: 0 };
      }
      return {
        androidId: aid,
        key: String(val.key ?? ""),
        banned: Boolean(val.banned ?? false),
        reason: String(val.reason ?? ""),
        until: String(val.until ?? ""),
        updatedAt: Number(val.updatedAt ?? 0)
      };
    }

    // ===== Auth flow =====
    onAuthStateChanged(auth, async (user) => {
      state.current = user;
      const uid = user?.uid ?? "-";
      badgeUid.textContent = "UID: " + uid;

      if(!user){
        hide(panel);
        show(authCard);
        badgeAdmin.textContent = "Admin: -";
        badgeOwner.textContent = "Owner";
        ownerBox.classList.add("hidden");
        return;
      }

      // Check admin flag
      const snap = await get(ref(db, "admins/" + uid));
      const isAdmin = snap.exists() && snap.val() === true;
      const isOwner = uid === OWNER_UID;
      state.isAdmin = isAdmin || isOwner;
      state.isOwner = isOwner;

      badgeAdmin.textContent = "Admin: " + (state.isAdmin ? "true" : "false");
      badgeOwner.classList.toggle("ok", isOwner);
      ownerBox.classList.toggle("hidden", !isOwner);

      if(!state.isAdmin){
        alert("Akun ini bukan admin. Minta owner untuk grant di /admins.");
        await signOut(auth);
        return;
      }

      // Success → tampilkan panel, sembunyikan login
      hide(authCard);
      show(panel);

      // Muat awal (tanpa tombol List)
      clearTable();
      state.lastKey = null;
      await loadFirstPage();
    });

    // Login / Logout
    btnLogin.addEventListener("click", async ()=>{
      try{
        btnLogin.disabled = true;
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value.trim());
      }catch(e){
        console.error(e); alert("Login gagal: " + e.message);
      }finally{ btnLogin.disabled = false; }
    });
    btnLogout.addEventListener("click", async ()=>{
      await signOut(auth);
    });

    // ===== CRUD quick form =====
    btnSave.addEventListener("click", async ()=>{
      const aid = f_androidId.value.trim();
      const key = f_key.value.trim();
      const reason = f_reason.value.trim();
      const until = f_until.value.trim();

      if(!isValidKeyPath(aid)){
        alert("Android ID tidak valid. Tidak boleh mengandung . $ # [ ] /");
        return;
      }
      if(!key){
        alert("Key wajib diisi."); return;
      }
      const data = {
        key, banned: false,
        reason: reason || "",
        until: until || "",
        updatedAt: Date.now()
      };
      try{
        await update(ref(db, "users/" + aid), data);
        toast("Tersimpan.");
        // refresh row spesifik kalau ada di table
        const row = document.querySelector(`tr[data-id="${aid}"]`);
        if(row){ await reloadRow(aid, row); }
        else {
          // push ke atas
          prependRow(aid, data);
        }
      }catch(e){
        console.error(e); alert("Gagal simpan: " + e.message);
      }
    });

    btnDelete.addEventListener("click", async ()=>{
      const aid = f_androidId.value.trim();
      if(!isValidKeyPath(aid)){ alert("Android ID tidak valid."); return; }
      if(!confirm("Hapus user ini?")) return;
      try{
        await remove(ref(db, "users/" + aid));
        toast("Dihapus.");
        const row = document.querySelector(`tr[data-id="${aid}"]`);
        if(row) row.remove();
        checkEmpty();
      }catch(e){ alert("Gagal hapus: " + e.message); }
    });

    // ===== Search behaviour =====
    btnRunSearch.addEventListener("click", async ()=>{
      await runSearch();
    });
    q_exact.addEventListener("keydown", (e)=>{ if(e.key === "Enter") runSearch(); });
    q_prefix.addEventListener("keydown", (e)=>{ if(e.key === "Enter") runSearch(); });

    async function runSearch(){
      const exact = q_exact.value.trim();
      const prefix = q_prefix.value.trim();

      clearTable();
      state.lastKey = null;

      try{
        if(exact){
          const snap = await get(ref(db, "users/"+exact));
          if(snap.exists()){
            const u = normalizeUser(exact, snap.val());
            renderRows([u]);
          }else{
            renderRows([]);
          }
          return;
        }
        // prefix mode
        if(prefix){
          const qy = query(ref(db, "users"), orderByKey(), startAt(prefix), endAt(prefix+"\uf8ff"), limitToFirst(100));
          const snap = await get(qy);
          const arr = [];
          snap.forEach(ch => arr.push(normalizeUser(ch.key, ch.val())));
          renderRows(arr);
          return;
        }
        // default: first page
        await loadFirstPage();
      }catch(e){
        console.error(e); alert("Gagal memuat data: " + e.message);
      }
    }

    // ===== List paging (default) =====
    async function loadFirstPage(){
      await loadMore(true);
    }
    btnMore.addEventListener("click", ()=> loadMore(false));

    async function loadMore(reset){
      if(state.busy) return;
      state.busy = true;
      try{
        let qy;
        if(!state.lastKey){
          qy = query(ref(db,"users"), orderByKey(), limitToFirst(50));
        }else{
          qy = query(ref(db,"users"), orderByKey(), startAt(state.lastKey), limitToFirst(51)); // +1 untuk skip dupe
        }
        const snap = await get(qy);
        const arr=[];
        let first = true;
        snap.forEach(ch => {
          if(state.lastKey && first){ first=false; return; } // skip duplicate
          arr.push(normalizeUser(ch.key, ch.val()));
        });
        if(arr.length){
          state.lastKey = arr[arr.length-1].androidId;
        }
        if(reset) clearTable();
        renderRows(arr, true);
      }catch(e){
        console.error(e); alert("Gagal memuat data: " + e.message);
      }finally{
        state.busy = false;
      }
    }

    // ===== Table render =====
    function clearTable(){
      tbody.innerHTML = "";
      rowEmpty && rowEmpty.remove();
      checkEmpty();
    }
    function checkEmpty(){
      if(!tbody.children.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5; td.className = "muted"; td.textContent = "Belum ada data user yang dimuat.";
        tr.appendChild(td); tbody.appendChild(tr);
      }
    }
    function renderRows(list, append=false){
      if(!append) clearTable();
      if(!list || !list.length){ checkEmpty(); return; }
      for(const u of list){
        if(!u) continue;
        tbody.appendChild(buildRow(u));
      }
    }
    function prependRow(aid, raw){
      const u = normalizeUser(aid, raw);
      const tr = buildRow(u);
      tbody.prepend(tr);
    }
    function buildRow(u){
      const tr = document.createElement("tr");
      tr.dataset.id = u.androidId;
      tr.innerHTML = `
        <td class="nowrap"><strong>${u.androidId}</strong></td>
        <td><input data-k="key" value="${escapeHtml(u.key)}" /></td>
        <td>
          <select data-k="banned">
            <option value="false" ${!u.banned?"selected":""}>false</option>
            <option value="true"  ${u.banned?"selected":""}>true</option>
          </select>
          <div class="row" style="gap:6px;margin-top:6px">
            <input data-k="until" placeholder="dd-mm-yyyy / epoch" value="${escapeHtml(u.until||"")}" />
            <input data-k="reason" placeholder="reason" value="${escapeHtml(u.reason||"")}" />
          </div>
        </td>
        <td class="muted">${fmtTime(u.updatedAt)}</td>
        <td class="t-actions">
          <button data-act="save" class="btn-ok">Save</button>
          <button data-act="del"  class="btn-err">Del</button>
        </td>
      `;
      tr.querySelector('[data-act="save"]').addEventListener("click", async ()=>{
        await saveRow(tr);
      });
      tr.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
        if(confirm("Hapus user ini?")){
          await remove(ref(db, "users/"+u.androidId));
          tr.remove(); checkEmpty();
        }
      });
      return tr;
    }

    async function saveRow(tr){
      const aid = tr.dataset.id;
      const key = tr.querySelector('[data-k="key"]').value.trim();
      const banned = tr.querySelector('[data-k="banned"]').value === "true";
      const until = tr.querySelector('[data-k="until"]').value.trim();
      const reason = tr.querySelector('[data-k="reason"]').value.trim();
      const data = { key, banned, until, reason, updatedAt: Date.now() };
      await update(ref(db, "users/"+aid), data);
      await reloadRow(aid, tr);
      toast("Tersimpan.");
    }

    async function reloadRow(aid, tr){
      const snap = await get(ref(db, "users/"+aid));
      if(!snap.exists()){ tr.remove(); checkEmpty(); return; }
      const u = normalizeUser(aid, snap.val());
      // patch
      tr.querySelector('[data-k="key"]').value = u.key;
      tr.querySelector('[data-k="banned"]').value = String(u.banned);
      tr.querySelector('[data-k="until"]').value = u.until || "";
      tr.querySelector('[data-k="reason"]').value = u.reason || "";
      tr.children[3].textContent = fmtTime(u.updatedAt);
    }

    // ===== Admin management (Owner only) =====
    btnGrant.addEventListener("click", async ()=>{
      if(!state.isOwner){ alert("Hanya owner."); return; }
      const id = adm_uid.value.trim();
      if(!id){ alert("UID kosong"); return; }
      await set(ref(db,"admins/"+id), true);
      alert("Granted.");
    });
    btnRevoke.addEventListener("click", async ()=>{
      if(!state.isOwner){ alert("Hanya owner."); return; }
      const id = adm_uid.value.trim();
      if(!id){ alert("UID kosong"); return; }
      await remove(ref(db,"admins/"+id));
      alert("Revoked.");
    });

    // ===== Utils =====
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.position="fixed"; el.style.left="50%"; el.style.bottom="16px"; el.style.transform="translateX(-50%)";
      el.style.background="var(--pri)"; el.style.border="1px solid var(--pri-700)"; el.style.color="#fff";
      el.style.padding="10px 14px"; el.style.borderRadius="10px"; el.style.zIndex="9999";
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1400);
    }
  </script>
</body>
</html>
