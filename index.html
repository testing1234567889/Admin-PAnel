<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>GxMods Admin Panel</title>
  <style>
    :root {
      --bg: #0e1116;
      --card: #111722;
      --muted: #1a2230;
      --muted-2: #0f1a28;
      --stroke: #243248;
      --text: #e6eefc;
      --sub: #9fb3d1;
      --accent: #4da3ff;
      --accent-2: #2f7fde;
      --danger: #ff5f66;
      --ok: #2ec27e;
      --warn: #ffb020;
      --chip: rgba(77,163,255,.14);
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 14px;
      --radius-sm: 10px;
    }
    * { box-sizing: border-box; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, 'Noto Sans', sans-serif;}
    a { color: var(--accent); text-decoration: none;}
    .wrap { max-width: 1180px; margin: 28px auto; padding: 0 16px; }
    header.card { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:16px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)) , var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .pill { display:inline-flex; align-items:center; gap:8px; background: var(--chip); padding:8px 12px; border-radius: 999px; color: var(--text); border:1px solid var(--stroke); }
    .row { display:flex; gap:12px; align-items:center; }
    .grow { flex:1; }
    .muted { color: var(--sub); }
    .bad { background: rgba(255,95,102,.15); border-color: #70333a; }
    .good { background: rgba(46,194,126,.16); border-color: #2c6a53; }
    .btn {
      background: var(--accent);
      color: white;
      border: 1px solid var(--accent-2);
      border-radius: 11px; padding: 10px 16px; cursor:pointer;
      transition: transform .06s ease, box-shadow .06s ease, background .2s ease;
      box-shadow: 0 4px 14px rgba(77,163,255,.25);
      user-select:none;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { opacity:.55; cursor:not-allowed; transform:none; }
    .btn.alt { background: transparent; color: var(--text); border-color: var(--stroke); }
    .btn.bad { background: var(--danger); border-color: #b33a41; box-shadow: 0 6px 16px rgba(255,95,102,.25); }
    .btn.good { background: var(--ok); border-color: #1b8a5e; box-shadow: 0 6px 16px rgba(46,194,126,.25); color:#0a1610;}
    .btn.small { padding:8px 12px; border-radius:10px; }
    .btn.ghost { background: transparent; color: var(--text); border: 1px dashed var(--stroke); }
    input, select, textarea {
      width:100%; background: var(--muted); border:1px solid var(--stroke); color: var(--text);
      padding: 12px 14px; border-radius: 12px; outline:none;
    }
    textarea { min-height: 86px; resize: vertical; }
    label { display:block; margin: 10px 0 6px; color: var(--sub); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid > .card { padding:18px; }
    .hidden { display:none !important; }
    .table {
      width:100%; border-collapse: collapse; font-size: 13px;
    }
    .table thead th { text-align:left; color: var(--sub); border-bottom:1px solid var(--stroke); padding: 10px 8px; position: sticky; top:0; background: var(--card); }
    .table tbody td { border-bottom:1px solid var(--muted-2); padding:10px 8px; color: var(--text); }
    .table tr:hover td { background: #0f1a23; }
    .table input[type=checkbox] { width:18px; height:18px; }
    .toolbar { padding:12px; border-top:1px solid var(--stroke); display:flex; gap:10px; justify-content:flex-end; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); border-radius: 0 0 var(--radius) var(--radius);}
    .stack { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .chip { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background: var(--chip); color: var(--text); }
    .note { background: #0f1623; border:1px dashed var(--stroke); padding:12px; border-radius: 10px; color: var(--sub); }
    .kbar { display:flex; gap:8px; align-items:center; padding:12px; border-radius: var(--radius); background: var(--muted-2); border:1px solid var(--stroke); }
    .kbar input { background: transparent; border: none; flex:1; padding: 10px 12px; }
    .right { text-align:right; }
    .footer { margin-top: 18px; text-align:center; color: var(--sub); }
    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr; }
      header.card { flex-direction: column; align-items: stretch; gap: 12px; }
      .toolbar { position: sticky; bottom: 0; z-index: 3; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card" id="topBar">
      <div class="stack">
        <span class="pill" id="uidChip">UID: <b class="muted">-</b></span>
        <span class="pill good" id="adminChip" title="Memiliki akses tulis">Admin: <b id="adminState">false</b></span>
        <span class="pill" id="ownerChip">Owner: <b id="ownerState">false</b></span>
      </div>
      <div class="row grow" id="authBar">
        <input id="authEmail" placeholder="email admin" autocomplete="username" />
        <input id="authPass" placeholder="password" type="password" autocomplete="current-password" />
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn alt" id="logoutBtn">Logout</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: editor -->
      <section class="card">
        <h3 style="margin:0 0 10px">Add / Edit User</h3>
        <div>
          <label>Android ID</label>
          <div class="row">
            <input id="f_id" placeholder="contoh: a1b2c3d4e5f6abcd" />
            <button class="btn small alt" id="copyIdBtn" title="Salin ID yang sedang diisi">Copy</button>
          </div>

          <label>Key</label>
          <div class="row">
            <input id="f_key" placeholder="ZXCV-9999-PAID" />
            <button class="btn small alt" id="genKeyBtn">Generate</button>
            <button class="btn small alt" id="copyKeyBtn">Copy</button>
          </div>

          <div class="row">
            <div class="grow">
              <label>Banned</label>
              <select id="f_banned">
                <option value="false">false</option>
                <option value="true">true</option>
              </select>
            </div>
            <div class="grow">
              <label>Until (dd-MM-yyyy atau epoch/ms, kosongkan jika tidak)</label>
              <input id="f_until" placeholder="25-12-2025 atau 1738510000000" />
            </div>
          </div>

          <label>Reason (opsional)</label>
          <textarea id="f_reason" placeholder="opsional"></textarea>

          <div class="row" style="margin-top:12px">
            <button class="btn" id="saveBtn">Create / Overwrite</button>
            <button class="btn alt" id="resetBtn">Reset</button>
          </div>

          <div class="note" style="margin-top:14px">
            <b>Kompatibilitas GxMods:</b> Panel menulis ke <code>/users/{androidId}</code> dalam <i>format objek</i>.
            Dialog Android-mu tetap bisa membaca jika suatu node tersimpan sebagai <i>string</i> (nilai = key).
            Panel ini otomatis menampilkan keduanya.
          </div>
        </div>
      </section>

      <!-- RIGHT: list -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Users List</h3>
          <div class="row">
            <button class="btn small alt" id="btnAll">List (100)</button>
            <button class="btn small alt" id="btnBanned">List Banned</button>
          </div>
        </div>

        <div class="kbar" style="margin-top:10px">
          <span class="muted">Cari prefix Android</span>
          <input id="searchPrefix" placeholder="mis. a1b2" />
          <button class="btn small alt" id="btnSearchPrefix">Search Prefix</button>
          <button class="btn small alt" id="btnClearPrefix">Clear</button>
        </div>

        <div style="overflow:auto; max-height: 52vh; margin-top: 10px;" id="tableWrap">
          <table class="table" id="usersTable">
            <thead>
              <tr>
                <th style="width:40px">Sel</th>
                <th>Android ID</th>
                <th>Key</th>
                <th class="right">Banned</th>
                <th>Until</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="6" class="muted">Belum ada data user yang dimuat.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="row" style="margin-top:10px; justify-content:flex-start">
          <button class="btn small alt" id="prevBtn">Prev</button>
          <button class="btn small alt" id="nextBtn">Next</button>
        </div>

        <div class="toolbar">
          <button class="btn bad" id="banSelBtn">Ban Selected</button>
          <button class="btn good" id="unbanSelBtn">Unban Selected</button>
          <button class="btn bad alt" id="delSelBtn">Delete Selected</button>
        </div>
      </section>
    </div>

    <p class="footer">© GxMods Admin Panel — Firebase Realtime Database</p>
  </div>

  <script type="module">
    // ===== Firebase CDN (v10) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, get, child, set, update, remove, query, orderByKey, orderByChild, equalTo, startAt, endAt, limitToFirst } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // ===== Config (punyamu) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
      authDomain: "animeplay-738a4.firebaseapp.com",
      databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
      projectId: "animeplay-738a4",
      storageBucket: "animeplay-738a4.firebasestorage.app",
      messagingSenderId: "129738568083",
      appId: "1:129738568083:web:d144ad8d1a66d893213866",
      measurementId: "G-J6G96TPMHX"
    };
    const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch (e) { /* ignore if blocked */ }
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== el helper =====
    const $ = (q) => document.querySelector(q);
    const uidChip = $("#uidChip b");
    const adminChip = $("#adminChip"); const adminState = $("#adminState");
    const ownerChip = $("#ownerChip"); const ownerState = $("#ownerState");
    const authBar = $("#authBar");
    const loginBtn = $("#loginBtn");
    const logoutBtn = $("#logoutBtn");

    function toast(msg){
      console.log(msg);
      try { alert(msg); } catch (e){}
    }
    function fmtDate(ms){
      if (!ms) return "";
      if (typeof ms === "string" && ms.includes("-")) return ms; // already dd-MM-yyyy
      const d = new Date(+ms);
      const two = (n)=> (n<10?"0":"")+n;
      return two(d.getDate())+"-"+two(d.getMonth()+1)+"-"+d.getFullYear()+" "+two(d.getHours())+":"+two(d.getMinutes());
    }
    function keyFromString(){
      const a = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      const part = (n)=> Array.from({length:n},()=>a[Math.floor(Math.random()*a.length)]).join("");
      return "ZXCV-"+part(4)+"-"+part(4);
    }
    function setHidden(el, hide){ el.classList.toggle("hidden", !!hide); }
    function clearTable(msg="Belum ada data user yang dimuat."){
      $("#tbody").innerHTML = '<tr><td colspan="6" class="muted">'+msg+'</td></tr>';
    }

    // ===== auth wiring =====
    loginBtn.onclick = async () => {
      const email = $("#authEmail").value.trim();
      const pass = $("#authPass").value;
      if(!email || !pass) return toast("Isi email & password.");
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e){
        toast("Login gagal: "+e.code);
      }
    };
    logoutBtn.onclick = ()=> signOut(auth);

    // state & admin check
    let state = {
      uid: null,
      isAdmin: false,
      isOwner: false,
    };

    async function refreshBadges(){
      uidChip.textContent = state.uid || "-";
      adminState.textContent = state.isAdmin ? "true" : "false";
      ownerState.textContent = state.isOwner ? "true" : "false";
      adminChip.classList.toggle("good", state.isAdmin);
      ownerChip.classList.toggle("good", state.isOwner);
    }

    async function readAdmin(uid){
      try {
        const snap = await get(ref(db, "admins/"+uid));
        return snap.exists() && snap.val() === true;
      }catch(e){ return false; }
    }

    onAuthStateChanged(auth, async (user) => {
      state.uid = user?.uid || null;
      state.isOwner = (state.uid === OWNER_UID);
      state.isAdmin = state.uid ? await readAdmin(state.uid) : false;

      // UI: hide auth when logged-in; show otherwise
      setHidden(authBar, !!user);

      await refreshBadges();

      // after login, load first page (even jika bukan admin: read tetap boleh)
      loadMode = "all";
      prefixFilter = "";
      pagination.reset();
      await loadTable();
    });

    // ===== editor wiring =====
    $("#genKeyBtn").onclick = ()=> $("#f_key").value = keyFromString();
    $("#copyIdBtn").onclick = ()=> navigator.clipboard.writeText($("#f_id").value||"");
    $("#copyKeyBtn").onclick = ()=> navigator.clipboard.writeText($("#f_key").value||"");
    $("#resetBtn").onclick = ()=>{ $("#f_id").value=""; $("#f_key").value=""; $("#f_banned").value="false"; $("#f_until").value=""; $("#f_reason").value=""; };

    $("#saveBtn").onclick = async ()=>{
      if(!state.isAdmin){ return toast("Akses ditolak. Akun ini bukan admin."); }
      const id = $("#f_id").value.trim();
      const key = $("#f_key").value.trim();
      if(!id || !key) return toast("Android ID & Key wajib diisi.");
      const banned = $("#f_banned").value === "true";
      const until = $("#f_until").value.trim();
      const reason = $("#f_reason").value.trim();

      const payload = { key, banned };
      if (until) payload.until = /^\d+$/.test(until) ? Number(until) : until;
      if (reason) payload.reason = reason;
      payload.updatedAt = Date.now();

      try{
        await set(ref(db, "users/"+id), payload);
        toast("Tersimpan.");
        pagination.reset(); // kembali ke page awal
        await loadTable();
      }catch(e){
        toast("Gagal simpan: "+e.code);
      }
    };

    // ===== list & actions =====
    const tbody = $("#tbody");
    let loadMode = "all"; // 'all' | 'banned' | 'prefix'
    let prefixFilter = "";
    const PAGE = 100;
    const pagination = {
      lastKey: null,
      firstKey: null,
      dir: "fwd",
      reset(){ this.lastKey = null; this.firstKey = null; this.dir="fwd"; }
    };

    $("#btnAll").onclick = async ()=>{ loadMode="all"; prefixFilter=""; pagination.reset(); await loadTable(); };
    $("#btnBanned").onclick = async ()=>{ loadMode="banned"; prefixFilter=""; pagination.reset(); await loadTable(); };
    $("#btnSearchPrefix").onclick = async ()=>{
      const p = $("#searchPrefix").value.trim();
      if(!p) return toast("Isi prefix Android ID."); 
      loadMode="prefix"; prefixFilter=p; pagination.reset(); await loadTable();
    };
    $("#btnClearPrefix").onclick = async ()=>{ $("#searchPrefix").value=""; loadMode="all"; prefixFilter=""; pagination.reset(); await loadTable(); };
    $("#prevBtn").onclick = async ()=>{ pagination.dir="back"; await loadTable(true); };
    $("#nextBtn").onclick = async ()=>{ pagination.dir="fwd"; await loadTable(true); };

    function rowHtml(id, obj){
      let key = "", banned = false, until="", updated="";
      if (typeof obj === "string"){ key = obj; }
      else if (obj && typeof obj === "object"){
        key = obj.key ?? "";
        banned = !!obj.banned;
        until = obj.until ?? "";
        updated = obj.updatedAt ? fmtDate(obj.updatedAt) : "";
      }
      const banStr = banned ? "<span class='chip bad'>true</span>" : "<span class='chip good'>false</span>";
      return `<tr data-id="${id}">
        <td><input type="checkbox" class="sel"></td>
        <td><a href="#" class="link-id">${id}</a></td>
        <td>${key || "<span class='muted'>-</span>"}</td>
        <td class="right">${banStr}</td>
        <td>${until || "<span class='muted'>-</span>"}</td>
        <td>${updated || "<span class='muted'>-</span>"}</td>
      </tr>`;
    }

    async function loadTable(isPageNav=false){
      clearTable("Memuat…");
      try {
        let q;
        if (loadMode === "banned"){
          // baca semua lalu filter (agar menangkap node bertipe string juga)
          const snap = await get(ref(db, "users"));
          if (!snap.exists()){ clearTable(); return; }
          const all = snap.val();
          const ids = Object.keys(all);
          ids.sort();
          const items = ids
            .map(k=>({ id:k, v: all[k] }))
            .filter(it => typeof it.v === "object" && it.v && (it.v.banned===true || it.v.banned==="true"));
          const page = items.slice(0, PAGE);
          renderRows(page);
          return;
        }
        if (loadMode === "prefix" && prefixFilter){
          const start = prefixFilter;
          const end = prefixFilter + "\uf8ff";
          q = query(ref(db, "users"), orderByKey(), startAt(start), endAt(end), limitToFirst(PAGE));
        } else {
          if (!pagination.lastKey || pagination.dir==="fwd"){
            q = query(ref(db, "users"), orderByKey(), limitToFirst(PAGE+1), startAt(pagination.lastKey || ""));
          } else {
            // fallback simple: always from beginning (Realtime DB tidak punya startAfter yang rapi)
            q = query(ref(db, "users"), orderByKey(), limitToFirst(PAGE));
          }
        }
        const snap = await get(q);
        if (!snap.exists()){ clearTable(); return; }
        const obj = snap.val();
        const ids = Object.keys(obj);
        if (pagination.lastKey && loadMode==="all"){
          // drop dupe pertama jika menggunakan startAt(lastKey)
          if (ids[0] === pagination.lastKey) ids.shift();
        }
        const sliceIds = ids.slice(0, PAGE);
        pagination.firstKey = sliceIds[0] || null;
        pagination.lastKey  = sliceIds[sliceIds.length-1] || null;

        const items = sliceIds.map(k => ({ id:k, v: obj[k] }));
        renderRows(items);
      } catch (e){
        clearTable("Gagal memuat data.");
        console.error(e);
      }
    }

    function renderRows(items){
      if (!items || items.length===0){ clearTable(); return; }
      tbody.innerHTML = items.map(it => rowHtml(it.id, it.v)).join("");
      // klik untuk load ke editor
      tbody.querySelectorAll(".link-id").forEach(a => {
        a.addEventListener("click", async (ev)=>{
          ev.preventDefault();
          const id = ev.target.closest("tr").dataset.id;
          const snap = await get(ref(db, "users/"+id));
          if (snap.exists()){
            const v = snap.val();
            $("#f_id").value = id;
            if (typeof v === "string"){ $("#f_key").value = v; $("#f_banned").value="false"; $("#f_until").value=""; $("#f_reason").value=""; }
            else {
              $("#f_key").value = v.key ?? "";
              $("#f_banned").value = (v.banned===true) ? "true" : "false";
              $("#f_until").value = (v.until ?? "");
              $("#f_reason").value = (v.reason ?? "");
            }
          }
        });
      });
    }

    // bulk actions
    function selectedIds(){
      return Array.from(tbody.querySelectorAll("input.sel:checked")).map(el => el.closest("tr").dataset.id);
    }
    $("#banSelBtn").onclick = async ()=>{
      if(!state.isAdmin) return toast("Akses ditolak (bukan admin).");
      const ids = selectedIds(); if(ids.length===0) return toast("Pilih data.");
      const payload = {};
      ids.forEach(id => payload["users/"+id+"/banned"] = true);
      payload["users/"+ids[0]+"/updatedAt"] = Date.now(); // minimal sentuh salah satu; RTDB tidak support multi-serverTimestamp
      await update(ref(db), payload);
      toast("Dibanned.");
      await loadTable();
    };
    $("#unbanSelBtn").onclick = async ()=>{
      if(!state.isAdmin) return toast("Akses ditolak (bukan admin).");
      const ids = selectedIds(); if(ids.length===0) return toast("Pilih data.");
      const payload = {};
      ids.forEach(id => payload["users/"+id+"/banned"] = false);
      payload["users/"+ids[0]+"/updatedAt"] = Date.now();
      await update(ref(db), payload);
      toast("Di-unban.");
      await loadTable();
    };
    $("#delSelBtn").onclick = async ()=>{
      if(!state.isAdmin) return toast("Akses ditolak (bukan admin).");
      const ids = selectedIds(); if(ids.length===0) return toast("Pilih data.");
      if(!confirm("Hapus "+ids.length+" data?")) return;
      const ops = ids.map(id => remove(ref(db, "users/"+id)));
      await Promise.all(ops);
      toast("Dihapus.");
      await loadTable();
    };

    // Initial list (tanpa login pun bisa baca)
    loadTable();
  </script>
</body>
</html>
