<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GxMods Admin Panel</title>
<style>
  :root{
    --bg:#0f141a;--card:#161c23;--muted:#11161c;--text:#e6eef8;--sub:#9fb3c8;
    --brand:#6aa3ff;--ok:#2ecc71;--danger:#ff6b6b;--stroke:#243140;--chip:#1d2631;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:15.5px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .chip{background:var(--chip);border:1px solid var(--stroke);padding:9px 12px;border-radius:999px;
        color:var(--text);font-size:13.5px}
  .chip.bad{background:#25181a;border-color:#3a2023;color:#ffb3b3}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  input,select,textarea{
    width:100%;border-radius:12px;border:1px solid var(--stroke);
    padding:12px 12px;background:#0c1218;color:var(--text);outline:none
  }
  input::placeholder,textarea::placeholder{color:#7f99b4}
  label{display:block;font-size:12.5px;color:var(--sub);margin:8px 0 6px}
  .btn{border:none;border-radius:12px;padding:11px 16px;font-weight:600;cursor:pointer}
  .btn.brand{background:var(--brand);color:#06111a}
  .btn.gray{background:#2a3a4e;color:#d2e3f5}
  .btn.ok{background:var(--ok);color:#07140a}
  .btn.danger{background:var(--danger);color:#220a0a}
  .btn.block{width:100%}
  .btn.small{padding:9px 12px;border-radius:10px;font-size:14px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;margin-bottom:14px}
  .card h2{margin:0 0 10px;font-size:18px}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

  /* ====== Users List: H-SCROLL ONLY ====== */
  .hl{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--stroke);
      border-radius:12px;background:transparent}
  .hl__inner{width:max-content;min-width:100%;padding:10px}
  .row-h{display:grid;align-items:center;gap:10px;
         grid-template-columns:minmax(200px,1fr) minmax(180px,1fr) minmax(100px,.6fr) minmax(180px,1fr) minmax(130px,.6fr);
         background:var(--muted);border:1px solid var(--stroke);border-radius:10px;margin-bottom:8px}
  .row-h.header{background:#1a212a;color:#9fb3c8;font-size:13.5px}
  .cell{padding:10px}
  .cell.actions{display:flex;gap:8px;align-items:center}
  .empty{padding:10px;color:#9fb3c8}
  .hint{font-size:12px;color:#8aa3bd;margin:6px 0 8px}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar" id="topBadges">
    <span class="chip" id="uidChip">UID: -</span>
    <span class="chip" id="adminChip">Admin:false</span>
    <span class="chip" id="ownerChip">Owner:false</span>
    <span class="chip bad hidden" id="warnDomain">Tambahkan domain Pages ke Auth → Authorized domains.</span>
    <div style="flex:1"></div>
    <div class="actions" id="loginRow">
      <input id="email" placeholder="email admin" style="min-width:180px">
      <input id="password" type="password" placeholder="password" style="min-width:150px">
      <button class="btn small brand" id="btnLogin">Login</button>
    </div>
    <button class="btn small gray hidden" id="btnLogout">Logout</button>
  </div>

  <div class="grid">
    <!-- KIRI: FORM -->
    <div class="card">
      <h2>Buat / Ubah User</h2>
      <label>Android ID</label>
      <input id="formId" placeholder="contoh: a1b2c3d4e5f6abcd" />
      <label>Key</label>
      <input id="formKey" placeholder="contoh: ZXCV-5R3K-PAID" />
      <label>Alasan (opsional)</label>
      <input id="formReason" placeholder="Misal: Abuse" />
      <div style="display:grid;gap:10px;grid-template-columns:1fr 140px">
        <div>
          <label>Sampai (opsional, 25-12-2025 / 1735171200000)</label>
          <input id="formUntil" placeholder="dd-mm-yyyy ATAU epoch(ms)" />
        </div>
        <div>
          <label>Banned</label>
          <select id="formBanned"><option>false</option><option>true</option></select>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn ok block" id="btnSave">Simpan</button>
        <button class="btn danger block" id="btnDelete">Hapus</button>
      </div>
      <p style="color:#8aa3bd;margin:10px 2px 0">Kolom “Android ID” & “Key” wajib. Tanpa tombol copy & tanpa generate sesuai permintaan.</p>
    </div>

    <!-- KANAN: USERS LIST -->
    <div class="card">
      <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
        <button class="btn small gray hidden" id="btnLogout2">Logout</button>
      </div>
      <h2>Users List</h2>

      <label>Pencarian (Android ID penuh)</label>
      <input id="searchExact" placeholder="tempel Android ID untuk cari 1 user" />
      <div style="display:grid;gap:10px;grid-template-columns:1fr 120px;margin-top:10px">
        <div>
          <label>Search Prefix</label>
          <input id="searchPrefix" placeholder="misal: a1b2">
        </div>
        <div style="align-self:end">
          <button class="btn brand block" id="btnSearch">Search</button>
        </div>
      </div>

      <!-- Hanya Users List yang bisa di-swipe, halaman tetap mobile-first -->
      <p class="hint">Geser tabel ke samping (↔) kalau kolom tidak muat.</p>
      <div class="hl">
        <div class="hl__inner">
          <div class="row-h header">
            <div class="cell">Android ID</div>
            <div class="cell">Key</div>
            <div class="cell">Banned</div>
            <div class="cell">Until</div>
            <div class="cell">Aksi</div>
          </div>
          <div id="listArea"></div>
        </div>
      </div>

      <div style="display:flex;justify-content:center;margin-top:8px">
        <button id="btnMore" class="btn gray hidden">Muat lebih</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Kelola Admin (Owner saja)</h2>
    <label>UID</label>
    <input id="adminUid" placeholder="tempel UID untuk grant / revoke">
    <div class="actions" style="margin-top:10px">
      <button class="btn ok" id="btnGrant">Grant Admin</button>
      <button class="btn danger" id="btnRevoke">Revoke Admin</button>
    </div>
    <p style="color:#8aa3bd;margin:10px 2px 0">Owner: <span id="ownerId"></span></p>
  </div>
</div>

<!-- ====== LOGIKA TETAP (tidak diubah) ====== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, get, set, update, remove, query, orderByKey, limitToFirst, startAt, endAt } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBpsA9-X9ckiyz2erxurJdLOzv-Deoi7R0",
    authDomain: "animeplay-738a4.firebaseapp.com",
    databaseURL: "https://animeplay-738a4-default-rtdb.firebaseio.com",
    projectId: "animeplay-738a4",
    storageBucket: "animeplay-738a4.firebasestorage.app",
    messagingSenderId: "129738568083",
    appId: "1:129738568083:web:d144ad8d1a66d893213866",
    measurementId: "G-J6G96TPMHX",
  };
  const OWNER_UID = "SjEQCMqzEMb2PQclx8Iidde3reA3";
  document.getElementById("ownerId").textContent = OWNER_UID;

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const el=(id)=>document.getElementById(id);
  const $list=el("listArea"), $btnMore=el("btnMore");
  const $loginRow=el("loginRow"), $btnLogout=el("btnLogout"), $btnLogout2=el("btnLogout2");
  const $uidChip=el("uidChip"), $adminChip=el("adminChip"), $ownerChip=el("ownerChip");

  let isAdmin=false, isOwner=false, cursor=null, PAGE=25, lastPrefix="", exactMode=null;

  function setLoadingList(msg){ $list.innerHTML='<div class="empty">'+(msg||"Memuat...")+'</div>'; $btnMore.classList.add("hidden"); }
  function fmt(v){ return (v==null?"":String(v)); }

  function setTopBadges(user, admin){
    $uidChip.textContent="UID: "+(user?user.uid:"-");
    $adminChip.textContent="Admin:"+(admin?"true":"false");
    isOwner=!!user && user.uid===OWNER_UID;
    $ownerChip.textContent="Owner:"+(isOwner?"true":"false");
    if(user){ $loginRow.classList.add("hidden"); $btnLogout.classList.remove("hidden"); $btnLogout2.classList.remove("hidden"); }
    else{ $loginRow.classList.remove("hidden"); $btnLogout.classList.add("hidden"); $btnLogout2.classList.add("hidden"); }
    document.querySelectorAll(".needAdmin").forEach(c=>c.disabled=!admin);
  }

  function rowNode(aid, data){
    const banned = data?.banned===true ? "true" : "false";
    const until = fmt(data?.until);
    const key = (typeof data==="string") ? data : fmt(data?.key);
    const reason = (typeof data==="string") ? "" : fmt(data?.reason);

    const row=document.createElement("div");
    row.className="row-h";
    row.innerHTML=`
      <div class="cell" style="font-weight:600">${aid}</div>
      <div class="cell"><input class="inpKey needAdmin" value="${key||""}" placeholder="key"></div>
      <div class="cell">
        <select class="inpBan needAdmin">
          <option ${banned==="false"?"selected":""}>false</option>
          <option ${banned==="true"?"selected":""}>true</option>
        </select>
      </div>
      <div class="cell"><input class="inpUntil needAdmin" value="${until||""}" placeholder="dd-mm-yyyy / epoch"></div>
      <div class="cell actions">
        <button class="btn small ok needAdmin">Save</button>
        <button class="btn small danger needAdmin">Del</button>
        <input class="inpReason needAdmin hidden" value="${reason}">
      </div>`;
    const btnSave=row.querySelector(".btn.ok");
    const btnDel=row.querySelector(".btn.danger");
    btnSave.onclick=async()=>{
      if(!isAdmin){alert("Hanya admin.");return;}
      const payload={
        key: row.querySelector(".inpKey").value.trim(),
        banned: row.querySelector(".inpBan").value==="true",
        until: row.querySelector(".inpUntil").value.trim(),
        reason: row.querySelector(".inpReason").value.trim(),
        updatedAt: Date.now()
      };
      if(!payload.key){ alert("Key wajib."); return; }
      await update(ref(db,"users/"+aid), payload);
      btnSave.textContent="Saved"; setTimeout(()=>btnSave.textContent="Save",1100);
    };
    btnDel.onclick=async()=>{
      if(!isAdmin){alert("Hanya admin.");return;}
      if(!confirm("Hapus user "+aid+" ?"))return;
      await remove(ref(db,"users/"+aid)); row.remove();
    };
    return row;
  }

  async function loadFirst(){ exactMode=null; lastPrefix=""; cursor=null; setLoadingList(); await loadPage(); }

  async function loadPage(){
    try{
      const base=ref(db,"users");
      if(exactMode){
        const s=await get(ref(db,"users/"+exactMode));
        $list.innerHTML="";
        if(!s.exists()){ $list.innerHTML='<div class="empty">Tidak ditemukan.</div>'; return; }
        $list.appendChild(rowNode(exactMode,s.val())); $btnMore.classList.add("hidden"); return;
      }
      let q;
      if(lastPrefix){
        q = cursor
          ? query(base, orderByKey(), startAt(cursor), endAt(lastPrefix+"\uf8ff"), limitToFirst(PAGE+1))
          : query(base, orderByKey(), startAt(lastPrefix), endAt(lastPrefix+"\uf8ff"), limitToFirst(PAGE+1));
      }else{
        q = cursor
          ? query(base, orderByKey(), startAt(cursor), limitToFirst(PAGE+1))
          : query(base, orderByKey(), limitToFirst(PAGE+1));
      }
      const snap=await get(q);
      const val=snap.val()||{}; let keys=Object.keys(val);
      if(cursor && keys.length && keys[0]===cursor){ keys.shift(); }
      if(!cursor){ $list.innerHTML=""; }
      if(keys.length===0 && !cursor){ $list.innerHTML='<div class="empty">Belum ada data user yang dimuat.</div>'; $btnMore.classList.add("hidden"); return; }
      keys.slice(0,PAGE).forEach(k=>$list.appendChild(rowNode(k,val[k])));
      if(keys.length>PAGE){ cursor=keys[PAGE]; $btnMore.classList.remove("hidden"); }
      else{ $btnMore.classList.add("hidden"); }
    }catch(e){ console.error(e); $list.innerHTML='<div class="empty">Gagal memuat data.</div>'; $btnMore.classList.add("hidden"); }
  }

  el("btnMore").onclick=loadPage;
  el("btnSearch").onclick=async()=>{
    const exact=el("searchExact").value.trim();
    const pref=el("searchPrefix").value.trim();
    if(exact){ exactMode=exact; setLoadingList(); await loadPage(); return; }
    lastPrefix=pref; cursor=null; exactMode=null; setLoadingList(); await loadPage();
  };

  el("btnSave").onclick=async()=>{
    if(!isAdmin){alert("Hanya admin.");return;}
    const id=el("formId").value.trim(), key=el("formKey").value.trim();
    if(!id||!key){alert("Android ID & Key wajib.");return;}
    const payload={
      key, banned:(el("formBanned").value==="true"), until:el("formUntil").value.trim(),
      reason:el("formReason").value.trim(), updatedAt:Date.now()
    };
    await set(ref(db,"users/"+id), payload); alert("Tersimpan."); await loadFirst();
  };
  el("btnDelete").onclick=async()=>{
    if(!isAdmin){alert("Hanya admin.");return;}
    const id=el("formId").value.trim(); if(!id){alert("Masukkan Android ID untuk hapus.");return;}
    if(!confirm("Hapus user "+id+" ?"))return; await remove(ref(db,"users/"+id)); alert("Terhapus."); await loadFirst();
  };

  el("btnGrant").onclick=async()=>{ if(!isOwner){alert("Hanya owner.");return;}
    const uid=el("adminUid").value.trim(); if(!uid)return; await set(ref(db,"admins/"+uid),true); alert("Granted."); };
  el("btnRevoke").onclick=async()=>{ if(!isOwner){alert("Hanya owner.");return;}
    const uid=el("adminUid").value.trim(); if(!uid)return; await remove(ref(db,"admins/"+uid)); alert("Revoked."); };

  el("btnLogin").onclick=async()=>{
    const email=el("email").value.trim(), pass=el("password").value.trim();
    if(!email||!pass){alert("Isi email & password.");return;}
    try{ await signInWithEmailAndPassword(auth,email,pass); }catch(e){ alert("Login gagal: "+(e?.message||e)); }
  };
  async function doLogout(){ try{ await signOut(auth); }catch{} }
  $btnLogout.onclick=doLogout; $btnLogout2.onclick=doLogout;

  async function refreshAdmin(uid){
    if(!uid){ isAdmin=false; setTopBadges(null,false); return; }
    try{ const v=await get(ref(db,"admins/"+uid)); isAdmin=v.exists() && v.val()===true; }catch{ isAdmin=false; }
    setTopBadges({uid}, isAdmin);
  }
  onAuthStateChanged(auth, async (user)=>{ await refreshAdmin(user?.uid||null); await loadFirst(); });
</script>
</body>
</html>
